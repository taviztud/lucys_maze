import{P as c}from"./phaser-0RJB29YE.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const l={GAME_WIDTH:600,GAME_HEIGHT:600,BOARD_SIZE:10,CELL_SIZE:60,MAZE_GENERATION:{OBSTACLE_PROBABILITY:.2,COIN_PROBABILITY:.1,TRAP_PROBABILITY:.05,MAX_ATTEMPTS:100,MIN_FREE_SPACES:4},AUDIO:{DEFAULT_VOLUME:.5,MAX_BG_TRACKS:14},UI:{GAME_OVER_FONT_SIZE:"48px",RESTART_FONT_SIZE:"24px",RESTART_OFFSET_Y:80,EXIT_BLINK_ALPHA_HIGH:1,EXIT_BLINK_ALPHA_LOW:.3,EXIT_BLINK_INTERVAL:200,FONT_FAMILY:'"Press Start 2P", cursive',MAIN_BACKGROUND_COLOR:"#1e1e2e"},BACKGROUND_COLORS:[5032432,16196997,4904557,16044894,7473591],GRID_ALPHA:.15,ENEMIES:{MIN_LEVEL_FOR_TWO:10,SINGLE_COUNT:1,DOUBLE_COUNT:2,MOVE_TWEEN_DURATION_MS:1e3},PERFORMANCE:{INPUT_THROTTLE_MS:16,ENEMY_UPDATE_THROTTLE_MS:16,PLAYER_MIN_STEP_DURATION_MS:200,PLAYER_BASE_DURATION_MS:400,PLAYER_STEP_DEC_PER_LEVEL:20},DEBUG:!1},S="lucys_maze_high_score";class M{static getHighScore(){try{const e=localStorage.getItem(S);return e?parseInt(e,10):0}catch{return 0}}static setHighScore(e){try{const t=this.getHighScore();return e>t?(localStorage.setItem(S,e.toString()),!0):!1}catch{return!1}}static isNewHighScore(e){return e>this.getHighScore()}static reset(){try{localStorage.removeItem(S)}catch{}}}class E extends c.Scene{constructor(){super("MenuScene")}preload(){this.load.image("player_stand","lucy_stand.png")}create(){const e=l.GAME_WIDTH/2,t=l.GAME_HEIGHT/2;this.cameras.main.setBackgroundColor(l.UI.MAIN_BACKGROUND_COLOR),this.add.text(e,t-180,"LUCY'S MAZE",{fontSize:"32px",fontFamily:l.UI.FONT_FAMILY,color:"#F72585",stroke:"#ff6600",strokeThickness:3}).setOrigin(.5),this.add.text(e,t-130,"¡Ayuda a Lucy a encontrar la salida!",{fontSize:"14px",fontFamily:l.UI.FONT_FAMILY,color:"#4CC9F0"}).setOrigin(.5);const r=this.add.sprite(e,t+60,"player_stand");r.setScale(3),r.setOrigin(.5,1),this.tweens.add({targets:r,scaleY:3.08,scaleX:2.95,duration:1200,yoyo:!0,repeat:-1,ease:"Sine.InOut"});const o=this.add.text(e,t+80,"▶ JUGAR",{fontSize:"24px",fontFamily:l.UI.FONT_FAMILY,color:"#00ff00",backgroundColor:"#003300",padding:{x:30,y:15}});o.setOrigin(.5),o.setInteractive({useHandCursor:!0}),o.on("pointerover",()=>{o.setStyle({color:"#ffffff",backgroundColor:"#006600"}),o.setScale(1.1)}),o.on("pointerout",()=>{o.setStyle({color:"#00ff00",backgroundColor:"#003300"}),o.setScale(1)}),o.on("pointerdown",()=>{this.startGame()});const a=M.getHighScore();this.add.text(e,t+160,`RÉCORD: ${a}`,{fontSize:"16px",fontFamily:l.UI.FONT_FAMILY,color:"#ff00ff"}).setOrigin(.5),this.add.text(e,t+220,"Usa las flechas ← ↑ → ↓ o desliza",{fontSize:"12px",fontFamily:l.UI.FONT_FAMILY,color:"#888888"}).setOrigin(.5),this.input.keyboard.on("keydown-ENTER",()=>this.startGame()),this.input.keyboard.on("keydown-SPACE",()=>this.startGame()),this.input.on("pointerdown",u=>{u.y<t+50||u.y>t+120})}startGame(){this.cameras.main.fadeOut(300,0,0,0),this.time.delayedCall(300,()=>{this.scene.start("GameScene")})}}function p(d,e,t){try{if(!t||!t.textures||!t.textures.get(d))return console.warn(`calculateSpriteScale: Invalid texture key "${d}"`),1;const i=t.textures.get(d).getSourceImage(),r=i.width,o=i.height;return Math.min(e/r,e/o)}catch(s){return console.error("Error calculating sprite scale:",s),1}}function g(d=[],e){if(Array.isArray(d)||(console.warn("generateFreePosition: excludePositions must be an array"),d=[]),!e||e<1)return console.error("generateFreePosition: Invalid boardSize:",e),null;const t=50;let s=0;for(;s<t;){const i={x:Math.floor(Math.random()*e),y:Math.floor(Math.random()*e)};if(!d.some(o=>o.x===i.x&&o.y===i.y))return i;s++}return console.warn("generateFreePosition: Could not find free position after",t,"attempts"),null}class T extends c.Scene{constructor(){super("GameScene"),this.boardSize=l.BOARD_SIZE,this.cellSize=l.CELL_SIZE,this.playerPosition={x:0,y:0},this.exitPosition={x:l.BOARD_SIZE-1,y:l.BOARD_SIZE-1},this.coins=[],this.obstacles=[],this.traps=[],this.saves=[],this.enemies=[],this.score=0,this.level=1,this.gameOver=!1,this.moving=!1,this.moveDirection={dx:0,dy:0},this.desiredDirection={dx:0,dy:0},this.playerMoveTween=null,this.exitBlinkState=!0,this.requireFreshPressAfterReset=!1,this.initialCoinCount=0,this.availableMusicKeys=[],this.backgroundMusic=null,this.musicPlaylistOrder=[],this.currentPlaylistIndex=0,this.collisionMap=null,this.lastEnemyUpdateTime=0,this.canUseSave=!1,this.spriteCache={coins:[],obstacles:[],traps:[]},this.eventListenerCleanup=[],this.coinParticles=null,this.trailParticles=null}preload(){try{this.load.on("loaderror",e=>{if(console.warn("Asset not found:",e.key,e.src),e.key.startsWith("backgroundMusic")){const t=this.availableMusicKeys.indexOf(e.key);t>-1&&this.availableMusicKeys.splice(t,1)}}),this.load.on("filecomplete",e=>{e.startsWith("backgroundMusic")&&(this.availableMusicKeys.includes(e)||this.availableMusicKeys.push(e))}),this.load.image("player_stand","lucy_stand.png"),this.load.image("player_run","lucy_run.png"),this.load.image("player_die","lucy_die.png"),this.load.image("coin","tuto.png"),this.load.image("obstacle_brick","brick_1.png"),this.load.image("obstacle_rock","rock_1.png"),this.load.image("obstacle_tree","tree_1.png"),this.load.image("trap","sping.png"),this.load.image("exit","exit.png"),this.load.image("enemy","enemy.png"),this.load.image("save","save.png"),this.detectAndLoadMusic()}catch(e){console.error("Critical error in preload:",e)}}detectAndLoadMusic(){this.availableMusicKeys=[];const e=l.AUDIO.MAX_BG_TRACKS;for(let t=1;t<=e;t++){const i=`bg_${t.toString().padStart(3,"0")}.mp3`,r=`backgroundMusic${t-1}`;try{this.load.audio(r,`sound/bg/${i}`)}catch(o){console.warn("Could not queue music file:",i,o)}}}create(){const e=()=>{this.availableMusicKeys.length>0?(this.shuffleMusicPlaylist(),this.playRandomMusic()):this.time.delayedCall(500,()=>{this.availableMusicKeys.length>0&&(this.shuffleMusicPlaylist(),this.playRandomMusic())})};this.sound.locked?(this.input.once("pointerdown",()=>this.sound.unlock()),this.input.keyboard&&this.input.keyboard.once("keydown",()=>this.sound.unlock()),this.sound.once("unlocked",e)):this.time.delayedCall(200,e),this.createGrid(),this.gameOverText=this.add.text(l.GAME_WIDTH/2,l.GAME_HEIGHT/2,"GAME OVER",{fontSize:l.UI.GAME_OVER_FONT_SIZE,fontFamily:l.UI.FONT_FAMILY,color:"#ff0000",stroke:"#ffffff",strokeThickness:4}),this.gameOverText.setOrigin(.5),this.gameOverText.setDepth(100),this.gameOverText.setVisible(!1),this.restartText=this.add.text(l.GAME_WIDTH/2,l.GAME_HEIGHT/2+l.UI.RESTART_OFFSET_Y,"PRESS R TO RESTART",{fontSize:l.UI.RESTART_FONT_SIZE,fontFamily:l.UI.FONT_FAMILY,color:"#ffff00",align:"center"}),this.restartText.setOrigin(.5),this.restartText.setDepth(100),this.restartText.setVisible(!1),this.generateRandomExit(),this.generateMaze(),this.initialCoinCount=this.coins.length,this.buildCollisionMap(),this.drawGame(),this.cursors=this.input.keyboard.createCursorKeys(),this.restartKey=this.input.keyboard.addKey(c.Input.Keyboard.KeyCodes.R),this.menuKey=this.input.keyboard.addKey(c.Input.Keyboard.KeyCodes.M),this.startExitAnimation(),this.setupUIEventListeners(),this.input.keyboard.on("keydown",t=>{switch(t.code){case"ArrowLeft":this.desiredDirection={dx:-1,dy:0};break;case"ArrowRight":this.desiredDirection={dx:1,dy:0};break;case"ArrowUp":this.desiredDirection={dx:0,dy:-1};break;case"ArrowDown":this.desiredDirection={dx:0,dy:1};break}!this.moving&&(this.desiredDirection.dx!==0||this.desiredDirection.dy!==0)&&!this.gameOver&&(this.movePlayer(this.desiredDirection.dx,this.desiredDirection.dy),this.requireFreshPressAfterReset=!1)}),this.setupTouchControls(),this.updateScoreAndLevelTexts(),this.level>=5&&this.initEnemies(),this.coinParticles=this.add.particles(0,0,"coin",{speed:{min:50,max:150},scale:{start:.4,end:0},lifespan:600,blendMode:"ADD",quantity:10,emitting:!1}),this.trailParticles=this.add.particles(0,0,"player_run",{speed:0,scale:{start:p("player_run",this.cellSize,this)*.9,end:.7},alpha:{start:.15,end:0},lifespan:1e3,blendMode:"ADD",frequency:140,emitting:!1})}update(e,t){if(this.gameOver){c.Input.Keyboard.JustDown(this.restartKey)&&(this.score=0,this.level=1,this.updateScoreAndLevelTexts(),this.resetGame(!0)),c.Input.Keyboard.JustDown(this.menuKey)&&this.returnToMenu();return}e>this.lastEnemyUpdateTime+l.PERFORMANCE.ENEMY_UPDATE_THROTTLE_MS&&(this.updateEnemies(),this.lastEnemyUpdateTime=e)}createGrid(){this.cameras.main.setBackgroundColor(l.UI.MAIN_BACKGROUND_COLOR);const e=l.BACKGROUND_COLORS[(this.level-1)%l.BACKGROUND_COLORS.length];this.gridGroup&&this.gridGroup.children?this.gridGroup.clear(!0,!0):this.gridGroup=this.add.group();const t=this.add.graphics();t.lineStyle(1,e,l.GRID_ALPHA);for(let s=0;s<=this.boardSize;s++)t.moveTo(s*this.cellSize,0),t.lineTo(s*this.cellSize,this.boardSize*this.cellSize),t.moveTo(0,s*this.cellSize),t.lineTo(this.boardSize*this.cellSize,s*this.cellSize);t.strokePath(),this.gridGroup.add(t);for(let s=0;s<this.boardSize;s++)for(let i=0;i<this.boardSize;i++){const r=this.add.rectangle(i*this.cellSize+this.cellSize/2,s*this.cellSize+this.cellSize/2,2,2,e);r.setAlpha(.6),this.gridGroup.add(r)}}generateRandomExit(){Math.floor(Math.random()*2)===0?this.exitPosition={x:this.boardSize-1,y:Math.floor(Math.random()*this.boardSize)}:this.exitPosition={x:Math.floor(Math.random()*this.boardSize),y:this.boardSize-1}}generateMaze(){try{if(!this.boardSize||this.boardSize<3){console.error("generateMaze: Invalid boardSize:",this.boardSize);return}let e=0;const t=l.MAZE_GENERATION.MAX_ATTEMPTS;do{e++,this.coins.length=0,this.obstacles.length=0,this.traps.length=0,this.saves.length=0;for(let s=0;s<this.boardSize;s++)for(let i=0;i<this.boardSize;i++)if((i!==0||s!==0)&&(i!==this.exitPosition.x||s!==this.exitPosition.y))if(Math.random()<l.MAZE_GENERATION.OBSTACLE_PROBABILITY&&this.hasEnoughSpace(i,s)){const r=["brick","rock","tree"],o=r[c.Math.Between(0,r.length-1)];this.obstacles.push({x:i,y:s,type:o})}else Math.random()<l.MAZE_GENERATION.COIN_PROBABILITY?this.coins.push({x:i,y:s}):Math.random()<l.MAZE_GENERATION.TRAP_PROBABILITY&&this.hasEnoughSpace(i,s)&&this.traps.push({x:i,y:s})}while(!this.isSolvable()&&e<t);e>=t&&(console.warn("generateMaze: Max attempts reached, generating simple maze"),this.coins.length=0,this.obstacles.length=0,this.traps.length=0,this.saves.length=0,this.coins.push({x:2,y:2},{x:5,y:5},{x:7,y:3}),this.obstacles.push({x:3,y:4,type:"brick"},{x:6,y:7,type:"rock"}))}catch(e){console.error("Error in generateMaze:",e),this.coins.length=0,this.obstacles.length=0,this.traps.length=0,this.saves.length=0,this.coins.push({x:1,y:1})}}isSolvable(){const e=[{x:this.playerPosition.x,y:this.playerPosition.y}],t=Array.from({length:this.boardSize},()=>Array(this.boardSize).fill(!1));t[this.playerPosition.y][this.playerPosition.x]=!0;const s=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}];for(;e.length>0;){const{x:i,y:r}=e.shift();if(i===this.exitPosition.x&&r===this.exitPosition.y)return!0;for(let o of s){const a=i+o.x,n=r+o.y;a>=0&&a<this.boardSize&&n>=0&&n<this.boardSize&&!t[n][a]&&!this.obstacles.some(h=>h.x===a&&h.y===n)&&!this.traps.some(h=>h.x===a&&h.y===n)&&(t[n][a]=!0,e.push({x:a,y:n}))}}return!1}hasEnoughSpace(e,t){const s=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0},{x:-1,y:-1},{x:1,y:-1},{x:-1,y:1},{x:1,y:1}];let i=0;for(let r of s){const o=e+r.x,a=t+r.y;o>=0&&o<this.boardSize&&a>=0&&a<this.boardSize&&!this.obstacles.some(n=>n.x===o&&n.y===a)&&!this.traps.some(n=>n.x===o&&n.y===a)&&i++}return i>=l.MAZE_GENERATION.MIN_FREE_SPACES}buildCollisionMap(){if(!this.boardSize||this.boardSize<1){console.error("buildCollisionMap: Invalid boardSize:",this.boardSize);return}try{this.collisionMap=Array.from({length:this.boardSize},()=>Array(this.boardSize).fill(!1)),this.obstacles.forEach(e=>{e.x>=0&&e.x<this.boardSize&&e.y>=0&&e.y<this.boardSize&&(this.collisionMap[e.y][e.x]=!0)})}catch(e){console.error("Error building collision map:",e),this.collisionMap=Array.from({length:this.boardSize||10},()=>Array(this.boardSize||10).fill(!1))}}drawGame(){this.clearSpriteCache(),this.coinSprites=this.coinSprites||[],this.obstacleSprites=this.obstacleSprites||[],this.trapSprites=this.trapSprites||[],this.playerSprite?(this.playerSprite.setPosition(this.playerPosition.x*this.cellSize+this.cellSize/2,this.playerPosition.y*this.cellSize+this.cellSize/2),this.playerSprite.setVisible(!0),this.playerSprite.setDepth(10)):this.playerSprite=this.add.sprite(this.playerPosition.x*this.cellSize+this.cellSize/2,this.playerPosition.y*this.cellSize+this.cellSize/2,"player_stand"),this.adjustPlayerScaleAndRotation(),this.exitSprite?(this.exitSprite.setPosition(this.exitPosition.x*this.cellSize+this.cellSize/2,this.exitPosition.y*this.cellSize+this.cellSize/2),this.exitSprite.setVisible(!0)):this.exitSprite=this.add.sprite(this.exitPosition.x*this.cellSize+this.cellSize/2,this.exitPosition.y*this.cellSize+this.cellSize/2,"exit");const e=p("exit",this.cellSize,this);if(this.exitSprite.setScale(e),this.startExitAnimation(),this.coinSprites=[],this.coins.forEach((t,s)=>{let i;if(this.spriteCache.coins[s]&&this.spriteCache.coins[s].active)i=this.spriteCache.coins[s],i.setPosition(t.x*this.cellSize+this.cellSize/2,t.y*this.cellSize+this.cellSize/2),i.setVisible(!0);else{i=this.add.sprite(t.x*this.cellSize+this.cellSize/2,t.y*this.cellSize+this.cellSize/2,"coin");const r=p("coin",this.cellSize,this);i.setScale(r),this.spriteCache.coins[s]=i}i.gridX=t.x,i.gridY=t.y,this.coinSprites.push(i)}),this.obstacleSprites=[],this.obstacles.forEach((t,s)=>{let i;if(this.spriteCache.obstacles[s]&&this.spriteCache.obstacles[s].active)i=this.spriteCache.obstacles[s],i.setPosition(t.x*this.cellSize+this.cellSize/2,t.y*this.cellSize+this.cellSize/2),i.setTexture(`obstacle_${t.type}`),i.setVisible(!0);else{i=this.add.sprite(t.x*this.cellSize+this.cellSize/2,t.y*this.cellSize+this.cellSize/2,`obstacle_${t.type}`);const r=p(`obstacle_${t.type}`,this.cellSize,this);i.setScale(r),this.spriteCache.obstacles[s]=i}i.obstacleType=t.type,i.gridX=t.x,i.gridY=t.y,this.obstacleSprites.push(i)}),this.trapSprites=[],this.traps.forEach((t,s)=>{let i;if(this.spriteCache.traps[s]&&this.spriteCache.traps[s].active)i=this.spriteCache.traps[s],i.setPosition(t.x*this.cellSize+this.cellSize/2,t.y*this.cellSize+this.cellSize/2),i.setVisible(!0);else{i=this.add.sprite(t.x*this.cellSize+this.cellSize/2,t.y*this.cellSize+this.cellSize/2,"trap");const o=p("trap",this.cellSize,this);i.setScale(o),this.spriteCache.traps[s]=i}const r=c.Math.Between(0,2e3);this.time.delayedCall(r,()=>{i&&i.active&&this.tweens.add({targets:i,angle:360,duration:1500,ease:"Cubic.InOut",repeat:-1,onRepeat:o=>{i.setAngle(0)}})}),this.trapSprites.push(i)}),this.saves.length>0){const t=this.saves[0];this.saveSprite?(this.saveSprite.setPosition(t.x*this.cellSize+this.cellSize/2,t.y*this.cellSize+this.cellSize/2),this.saveSprite.setVisible(!0)):this.saveSprite=this.add.sprite(t.x*this.cellSize+this.cellSize/2,t.y*this.cellSize+this.cellSize/2,"save");const s=p("save",this.cellSize,this);this.saveSprite.setScale(s),this.saveSprite.setAlpha(1),this.savePulseTween&&this.savePulseTween.stop(),this.savePulseTween=this.tweens.add({targets:this.saveSprite,scaleX:{from:s*.95,to:s*1.08},scaleY:{from:s*.95,to:s*1.08},alpha:{from:.9,to:1},ease:"Sine.InOut",duration:600,yoyo:!0,repeat:-1})}else this.saveSprite&&this.saveSprite.setVisible(!1);this.hideUnusedSprites(this.coinSprites,"coins"),this.hideUnusedSprites(this.obstacleSprites,"obstacles"),this.hideUnusedSprites(this.trapSprites,"traps"),this.level>=5&&this.enemies.forEach(t=>{t.sprite&&(t.direction.dx===-1?t.sprite.setFlipX(!0):t.direction.dx===1&&t.sprite.setFlipX(!1))})}movePlayer(e,t){if(this.gameOver||this.moving||e===0&&t===0)return;this.moveDirection={dx:e,dy:t};const s=this.calculateMoveUntilObstacle(this.playerPosition.x,this.playerPosition.y,e,t);if(s.distance===0){this.resetMovementState();return}this.startMovement();const i=this.calculateStepDuration(),r=this.calculateFinalDestination(e,t,s);this.executeMovementTween(e,t,i,r)}resetMovementState(){this.moveDirection={dx:0,dy:0},this.playerSprite&&(this.playerSprite.setTexture("player_stand"),this.adjustPlayerScaleAndRotation())}startMovement(){this.moving=!0,this.playerSprite.setTexture("player_run"),this.adjustPlayerScaleAndRotation(),this.trailParticles&&(this.trailParticles.start(),this.trailParticles.startFollow(this.playerSprite))}calculateStepDuration(){return Math.max(l.PERFORMANCE.PLAYER_MIN_STEP_DURATION_MS,l.PERFORMANCE.PLAYER_BASE_DURATION_MS-this.level*l.PERFORMANCE.PLAYER_STEP_DEC_PER_LEVEL)}calculateFinalDestination(e,t,s){const i=this.playerPosition.x,r=this.playerPosition.y,o={x:s.x,y:s.y,step:s.distance};for(let a=1;a<=s.distance;a++){const n=i+e*a,h=r+t*a;if(this.isTrapOptimized(n,h))return{x:n,y:h,step:a};if(this.enemies.some(u=>Math.round(u.x)===n&&Math.round(u.y)===h))return{x:n,y:h,step:a};if(n===this.exitPosition.x&&h===this.exitPosition.y)return{x:n,y:h,step:a}}return o}executeMovementTween(e,t,s,i){const r=this.playerPosition.x,o=this.playerPosition.y;let a=-1;this.playerMoveTween=this.tweens.add({targets:this.playerSprite,x:i.x*this.cellSize+this.cellSize/2,y:i.y*this.cellSize+this.cellSize/2,duration:s*i.step,ease:"Linear",onUpdate:n=>{const h=this.onMovementUpdate(n,e,t,r,o,i,a);h!==null&&(a=h)},onComplete:()=>{this.onMovementComplete(i)},callbackScope:this})}onMovementUpdate(e,t,s,i,r,o,a){const n=e.progress,h=Math.floor(n*o.step),u=Math.max(0,a+1);for(let y=u;y<=h;y++){const f=i+t*y,m=r+s*y;if(f!==this.playerPosition.x||m!==this.playerPosition.y){if(this.playerPosition.x=f,this.playerPosition.y=m,this.processItemsAtPosition(this.playerPosition.x,this.playerPosition.y),this.isTrapOptimized(this.playerPosition.x,this.playerPosition.y))return this.handleDeath(),null;if(this.enemies.some(x=>Math.round(x.x)===this.playerPosition.x&&Math.round(x.y)===this.playerPosition.y))return this.handleDeath(),null;if(this.playerPosition.x===this.exitPosition.x&&this.playerPosition.y===this.exitPosition.y)return this.handleLevelComplete(),null;if(this.checkTurnOpportunity(e))return null}}return h}checkTurnOpportunity(e){if((this.desiredDirection.dx!==0||this.desiredDirection.dy!==0)&&(this.desiredDirection.dx!==this.moveDirection.dx||this.desiredDirection.dy!==this.moveDirection.dy)){const t=this.playerPosition.x+this.desiredDirection.dx,s=this.playerPosition.y+this.desiredDirection.dy;if(!this.isCollisionOptimized(t,s))return this.playerSprite.setPosition(this.playerPosition.x*this.cellSize+this.cellSize/2,this.playerPosition.y*this.cellSize+this.cellSize/2),e.stop(),this.moving=!1,this.movePlayer(this.desiredDirection.dx,this.desiredDirection.dy),!0}return!1}onMovementComplete(e){if(this.trailParticles&&this.trailParticles.stop(),this.playerPosition.x=e.x,this.playerPosition.y=e.y,e.step>0&&!this.gameOver&&this.cameras.main.shake(100,.005),this.processItemsAtPosition(this.playerPosition.x,this.playerPosition.y),this.isTrapOptimized(this.playerPosition.x,this.playerPosition.y)){this.handleDeath();return}if(this.playerPosition.x===this.exitPosition.x&&this.playerPosition.y===this.exitPosition.y){this.handleLevelComplete();return}this.moving=!1,this.playerMoveTween=null,this.moveDirection={dx:0,dy:0},this.playerSprite.setTexture("player_stand"),this.adjustPlayerScaleAndRotation()}clearSpriteCache(){Object.keys(this.spriteCache).forEach(e=>{this.spriteCache[e].forEach(t=>{t&&t.destroy&&t.destroy()}),this.spriteCache[e]=[]})}hideUnusedSprites(e,t){const s=this.spriteCache[t];for(let i=e.length;i<s.length;i++)s[i]&&s[i].setVisible(!1)}adjustPlayerScaleAndRotation(){if(!this.playerSprite)return;const e=p(this.playerSprite.texture.key,this.cellSize,this);this.playerSprite.setScale(e),this.moveDirection.dx===1?(this.playerSprite.setAngle(0),this.playerSprite.setFlipX(!1)):this.moveDirection.dx===-1?(this.playerSprite.setAngle(0),this.playerSprite.setFlipX(!0)):this.moveDirection.dy===-1?(this.playerSprite.setAngle(-90),this.playerSprite.setFlipX(!1)):this.moveDirection.dy===1&&(this.playerSprite.setAngle(90),this.playerSprite.setFlipX(!1))}calculateMoveUntilObstacle(e,t,s,i){let r=e,o=t,a=0;for(;;){let n=r+s,h=o+i;if(this.isCollisionOptimized(n,h))break;r=n,o=h,a++}return{x:r,y:o,distance:a}}processItemsAtPosition(e,t){for(let s=this.coins.length-1;s>=0;s--)if(this.coins[s].x===e&&this.coins[s].y===t){this.coinParticles&&this.coinParticles.emitParticleAt(e*this.cellSize+this.cellSize/2,t*this.cellSize+this.cellSize/2),this.coins.splice(s,1),this.score+=10,this.updateScoreAndLevelTexts();for(let i=this.coinSprites.length-1;i>=0;i--)if(this.coinSprites[i].gridX===e&&this.coinSprites[i].gridY===t){this.coinSprites[i].destroy(),this.coinSprites.splice(i,1);break}this.initialCoinCount>0&&(this.initialCoinCount-this.coins.length)/this.initialCoinCount>.7&&this.saves.length===0&&(this.generateSaveItem(),this.drawGame());break}if(this.saves.length>0){const s=this.saves[0];s.x===e&&s.y===t&&(this.canUseSave=!0,this.saves.splice(0,1),this.saveSprite&&(this.savePulseTween&&(this.savePulseTween.stop(),this.savePulseTween=null),this.saveSprite.destroy(),this.saveSprite=null))}this.animateNearbyTrees(e,t)}animateNearbyTrees(e,t){this.obstacles.forEach((s,i)=>{if(s.type!=="tree")return;const r=Math.abs(s.x-e),o=Math.abs(s.y-t);if(r<=1&&o<=1&&r+o>0){const a=this.spriteCache.obstacles[i];if(a&&a.active&&!a.isSwaying){a.isSwaying=!0;const n=e<s.x?-1:1;this.tweens.add({targets:a,angle:{from:0,to:n*8},duration:150,ease:"Sine.InOut",yoyo:!0,repeat:1,onComplete:()=>{a.setAngle(0),a.isSwaying=!1}})}}})}isCollisionOptimized(e,t){return e<0||e>=this.boardSize||t<0||t>=this.boardSize?!0:this.collisionMap&&this.collisionMap[t]&&this.collisionMap[t][e]}isTrapOptimized(e,t){return e<0||e>=this.boardSize||t<0||t>=this.boardSize?!1:this.traps.some(s=>s.x===e&&s.y===t)}handleDeath(){this.gameOver=!0,this.moveDirection={dx:0,dy:0},this.playerMoveTween&&(this.playerMoveTween.stop(),this.playerMoveTween=null),this.moving=!1,this.drawGame(),this.showGameOver(),this.playerSprite&&(this.playerSprite.destroy(),this.playerSprite=null),this.playerDieSprite=this.add.sprite(this.playerPosition.x*this.cellSize+this.cellSize/2,this.playerPosition.y*this.cellSize+this.cellSize/2,"player_die");const e=p("player_die",this.cellSize,this);this.playerDieSprite.setScale(e)}handleLevelComplete(){this.score+=100,this.level+=1,this.updateScoreAndLevelTexts(),this.playerMoveTween&&(this.playerMoveTween.stop(),this.playerMoveTween=null),this.moving=!1,this.requireFreshPressAfterReset=!0,this.desiredDirection={dx:0,dy:0},this.resetGame(!1)}returnToMenu(){this.backgroundMusic&&this.backgroundMusic.stop(),this.newRecordText&&this.newRecordText.setVisible(!1),this.menuText&&this.menuText.setVisible(!1),this.cameras.main.fadeOut(300,0,0,0),this.time.delayedCall(300,()=>{this.scene.start("MenuScene")})}showGameOver(){const e=M.setHighScore(this.score);this.gameOverText.setVisible(!0),this.restartText.setVisible(!0),e&&this.score>0&&(this.newRecordText||(this.newRecordText=this.add.text(l.GAME_WIDTH/2,l.GAME_HEIGHT/2-60,"¡NUEVO RÉCORD!",{fontSize:"20px",fontFamily:l.UI.FONT_FAMILY,color:"#ffff00",stroke:"#ff6600",strokeThickness:3}),this.newRecordText.setOrigin(.5),this.newRecordText.setDepth(100)),this.newRecordText.setVisible(!0),this.tweens.add({targets:this.newRecordText,scaleX:1.2,scaleY:1.2,duration:400,yoyo:!0,repeat:-1})),this.menuText||(this.menuText=this.add.text(l.GAME_WIDTH/2,l.GAME_HEIGHT/2+l.UI.RESTART_OFFSET_Y+30,"PRESIONA M PARA MENÚ",{fontSize:"14px",fontFamily:l.UI.FONT_FAMILY,color:"#888888"}),this.menuText.setOrigin(.5),this.menuText.setDepth(100)),this.menuText.setVisible(!0),this.playerMoveTween&&(this.playerMoveTween.stop(),this.playerMoveTween=null),this.moving=!1}resetGame(e){e&&(this.level=1,this.score=0),this.playerPosition={x:0,y:0},this.generateRandomExit(),this.gameOver=!1,this.moveDirection={dx:0,dy:0},this.desiredDirection={dx:0,dy:0},this.canUseSave=!1,this.playerMoveTween&&(this.playerMoveTween.stop(),this.playerMoveTween=null),this.moving=!1,this.clearSpriteCache(),this.generateMaze(),this.initialCoinCount=this.coins.length,this.buildCollisionMap(),this.gameOverText.setVisible(!1),this.restartText.setVisible(!1),this.newRecordText&&this.newRecordText.setVisible(!1),this.menuText&&this.menuText.setVisible(!1),this.createGrid(),this.enemies.forEach(t=>{t&&t.sprite&&t.sprite.destroy()}),this.enemies=[],this.level>=5&&this.initEnemies(),this.playerDieSprite&&(this.playerDieSprite.destroy(),this.playerDieSprite=null),this.savePulseTween&&(this.savePulseTween.stop(),this.savePulseTween=null),this.saveSprite&&(this.saveSprite.destroy(),this.saveSprite=null),this.drawGame()}generateSaveItem(){const e=[this.playerPosition,this.exitPosition,...this.obstacles,...this.traps,...this.enemies.map(s=>({x:s.x,y:s.y}))],t=g(e,this.boardSize);t&&this.saves.length===0&&this.saves.push(t)}startExitAnimation(){if(!this.exitSprite)return;this.exitPulseTween&&this.exitPulseTween.stop();const e=p("exit",this.cellSize,this);this.exitPulseTween=this.tweens.add({targets:this.exitSprite,scaleX:{from:e*.95,to:e*1.1},scaleY:{from:e*.95,to:e*1.1},alpha:{from:.7,to:1},duration:800,ease:"Sine.InOut",yoyo:!0,repeat:-1})}initEnemies(){this.enemies=[];let e=this.level>=l.ENEMIES.MIN_LEVEL_FOR_TWO?l.ENEMIES.DOUBLE_COUNT:l.ENEMIES.SINGLE_COUNT;for(let t=0;t<e;t++){const s=[this.playerPosition,this.exitPosition,...this.obstacles,...this.traps,...this.enemies],i=g(s,this.boardSize);if(!i)continue;const r={x:i.x,y:i.y,direction:this.getRandomDirection(),moving:!1,sprite:null};r.sprite=this.add.sprite(r.x*this.cellSize+this.cellSize/2,r.y*this.cellSize+this.cellSize/2,"enemy");const o=p("enemy",this.cellSize,this);r.sprite.setScale(o),r.sprite.setFlipX(r.direction.dx===-1),this.enemies.push(r)}}getRandomDirection(){const e=[{dx:0,dy:-1},{dx:1,dy:0},{dx:0,dy:1},{dx:-1,dy:0}];return e[c.Math.Between(0,e.length-1)]}updateEnemies(){this.enemies.forEach(e=>{if(!(!e||!e.sprite)&&!e.moving){e.moving=!0;let t=e.x+e.direction.dx,s=e.y+e.direction.dy;this.isCollisionOptimized(t,s)?(e.direction=this.getRandomDirection(),e.moving=!1,e.sprite.setFlipX(e.direction.dx===-1)):this.tweens.add({targets:e.sprite,x:t*this.cellSize+this.cellSize/2,y:s*this.cellSize+this.cellSize/2,duration:l.ENEMIES.MOVE_TWEEN_DURATION_MS,onComplete:()=>{e.x=t,e.y=s,e.moving=!1,e.x===this.playerPosition.x&&e.y===this.playerPosition.y&&this.handleDeath()},callbackScope:this})}})}updateScoreAndLevelTexts(){const e=typeof this.score=="number"&&!isNaN(this.score)?this.score:0,t=typeof this.level=="number"&&!isNaN(this.level)?this.level:1,s=document.getElementById("score"),i=document.getElementById("level");s&&(s.textContent="Puntos: "+e),i&&(i.textContent="Nivel: "+t)}shuffleMusicPlaylist(){if(this.availableMusicKeys.length===0){this.musicPlaylistOrder=[],this.currentPlaylistIndex=0;return}this.musicPlaylistOrder=this.availableMusicKeys.map((e,t)=>this.availableMusicKeys[t]);for(let e=this.musicPlaylistOrder.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[this.musicPlaylistOrder[e],this.musicPlaylistOrder[t]]=[this.musicPlaylistOrder[t],this.musicPlaylistOrder[e]]}this.currentPlaylistIndex=0}playRandomMusic(){if(this.availableMusicKeys.length===0)return;this.backgroundMusic&&(this.backgroundMusic.stop(),this.backgroundMusic.destroy(),this.backgroundMusic=null),this.currentPlaylistIndex>=this.musicPlaylistOrder.length&&this.shuffleMusicPlaylist();const e=this.musicPlaylistOrder[this.currentPlaylistIndex];this.currentPlaylistIndex++,this.playSpecificMusic(e)}playSpecificMusic(e){try{if(!this.cache.audio.exists(e))return;this.backgroundMusic=this.sound.add(e,{loop:!1,volume:l.AUDIO.DEFAULT_VOLUME}),this.backgroundMusic.play(),this.backgroundMusic.once("complete",()=>{this.playRandomMusic()});const t=document.getElementById("toggle-music");t&&(t.textContent="Música Off")}catch(t){console.error("Error in playSpecificMusic:",t)}}setupTouchControls(){let e=0,t=0;const s=30;this.input.on("pointerdown",i=>{e=i.x,t=i.y}),this.input.on("pointerup",i=>{if(this.gameOver)return;const r=i.x-e,o=i.y-t,a=Math.abs(r),n=Math.abs(o);Math.max(a,n)<s||(a>n?this.desiredDirection={dx:r>0?1:-1,dy:0}:this.desiredDirection={dx:0,dy:o>0?1:-1},!this.moving&&!this.gameOver&&(this.movePlayer(this.desiredDirection.dx,this.desiredDirection.dy),this.requireFreshPressAfterReset=!1))})}setupUIEventListeners(){const e=document.getElementById("toggle-music"),t=document.getElementById("volume-slider"),s=document.getElementById("next-music"),i=document.getElementById("prev-music"),r=document.getElementById("restart-button");this.eventListenerCleanup.forEach(({element:a,event:n,handler:h})=>{a&&a.removeEventListener(n,h)}),this.eventListenerCleanup=[];const o=(a,n,h)=>{a&&(a.addEventListener(n,h),this.eventListenerCleanup.push({element:a,event:n,handler:h}))};o(e,"click",()=>{const a=this.sound;a&&a.context&&a.context.state==="suspended"&&a.context.resume().catch(()=>{}),this.backgroundMusic&&this.backgroundMusic.isPlaying?(this.backgroundMusic.pause(),e&&(e.textContent="Música On")):this.backgroundMusic?(this.backgroundMusic.resume(),e&&(e.textContent="Música Off")):(this.playRandomMusic(),e&&(e.textContent="Música Off"))}),o(t,"input",a=>{this.backgroundMusic&&this.backgroundMusic&&"setVolume"in this.backgroundMusic&&this.backgroundMusic.setVolume(parseFloat(a.target.value))}),o(s,"click",()=>{this.availableMusicKeys.length>0&&(this.currentPlaylistIndex>=this.musicPlaylistOrder.length&&this.shuffleMusicPlaylist(),this.playRandomMusic())}),o(i,"click",()=>{this.availableMusicKeys.length>0&&(this.currentPlaylistIndex=Math.max(0,this.currentPlaylistIndex-2),this.playRandomMusic())}),o(r,"click",()=>{this.canUseSave?this.resetGame(!1):(this.score=0,this.level=1,this.updateScoreAndLevelTexts(),this.resetGame(!0))})}}const v={type:c.AUTO,width:l.GAME_WIDTH,height:l.GAME_HEIGHT,backgroundColor:l.UI.MAIN_BACKGROUND_COLOR,parent:"game-container",pixelArt:!0,scale:{mode:c.Scale.FIT,autoCenter:c.Scale.CENTER_BOTH},scene:[E,T]};new c.Game(v);
//# sourceMappingURL=index-Wwg_BQDk.js.map
