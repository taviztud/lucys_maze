import{P as S}from"./phaser-0RJB29YE.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();const a={GAME_WIDTH:480,GAME_HEIGHT:720,BOARD_WIDTH:8,BOARD_HEIGHT:12,CELL_SIZE:60,MAZE_GENERATION:{OBSTACLE_PROBABILITY:.2,COIN_PROBABILITY:.1,TRAP_PROBABILITY:.05,MAX_ATTEMPTS:100,MIN_FREE_SPACES:4},AUDIO:{DEFAULT_VOLUME:.5,MAX_BG_TRACKS:26},UI:{GAME_OVER_FONT_SIZE:"48px",RESTART_FONT_SIZE:"24px",RESTART_OFFSET_Y:80,EXIT_BLINK_ALPHA_HIGH:1,EXIT_BLINK_ALPHA_LOW:.3,EXIT_BLINK_INTERVAL:200,FONT_FAMILY:'"Press Start 2P", cursive',MAIN_BACKGROUND_COLOR:"#1e1e2e"},BACKGROUND_COLORS:[5032432,16196997,4904557,16044894,7473591],GRID_ALPHA:.15,ENEMIES:{MIN_LEVEL_FOR_TWO:10,SINGLE_COUNT:1,DOUBLE_COUNT:2,MOVE_TWEEN_DURATION_MS:1e3,FIRST_SPAWN_LEVEL:5,SECOND_ENEMY_INTERVAL:7,MAX_COUNT:4},SPIDER:{MIN_PATROL_DISTANCE:3,WAIT_DURATION_MS:2e3,MOVE_SPEED:.05,FIRST_SPAWN_LEVEL:10,SECOND_SPAWN_LEVEL:15,THIRD_SPAWN_LEVEL:20},POWERUPS:{SPAWN_COIN_RATIO:.8,SHIELD_PROBABILITY:.8,SHIELD_INVINCIBILITY_MS:500},PERFORMANCE:{INPUT_THROTTLE_MS:16,ENEMY_UPDATE_THROTTLE_MS:16,PLAYER_MIN_STEP_DURATION_MS:60,PLAYER_BASE_DURATION_MS:400,PLAYER_STEP_DEC_PER_LEVEL:20,PLAYER_STEP_DEC_SLOW:5,PLAYER_STEP_DEC_TINY:1,PLAYER_PHASE1_MAX_LEVEL:10,PLAYER_PHASE2_MAX_LEVEL:34},DEBUG:!1},T="lucys_maze_high_score";class _{static getHighScore(){try{const e=localStorage.getItem(T);return e?parseInt(e,10):0}catch{return 0}}static setHighScore(e){try{const t=this.getHighScore();return e>t?(localStorage.setItem(T,e.toString()),!0):!1}catch{return!1}}static isNewHighScore(e){return e>this.getHighScore()}static reset(){try{localStorage.removeItem(T)}catch{}}}class I extends S.Scene{constructor(){super("MenuScene"),this.devModeData={enabled:!1,level:1,shields:0,continues:0,score:0},this.devPanel=null,this.devTexts={}}preload(){this.load.image("player_stand","lucy_stand.png")}create(){const e=a.GAME_WIDTH/2,t=a.GAME_HEIGHT/2;this.cameras.main.setBackgroundColor(a.UI.MAIN_BACKGROUND_COLOR),this.add.text(e,t-180,"LUCY'S MAZE",{fontSize:"32px",fontFamily:a.UI.FONT_FAMILY,color:"#F72585",stroke:"#ff6600",strokeThickness:3}).setOrigin(.5),this.add.text(e,t-130,"¡Ayuda a Lucy a encontrar la salida!",{fontSize:"14px",fontFamily:a.UI.FONT_FAMILY,color:"#4CC9F0"}).setOrigin(.5);const n=this.add.sprite(e,t+60,"player_stand");n.setScale(3),n.setOrigin(.5,1),this.tweens.add({targets:n,scaleY:3.08,scaleX:2.95,duration:1200,yoyo:!0,repeat:-1,ease:"Sine.InOut"});const r=this.add.text(e,t+80,"▶ JUGAR",{fontSize:"24px",fontFamily:a.UI.FONT_FAMILY,color:"#00ff00",backgroundColor:"#003300",padding:{x:30,y:15}});r.setOrigin(.5),r.setInteractive({useHandCursor:!0}),r.on("pointerover",()=>{r.setStyle({color:"#ffffff",backgroundColor:"#006600"}),r.setScale(1.1)}),r.on("pointerout",()=>{r.setStyle({color:"#00ff00",backgroundColor:"#003300"}),r.setScale(1)}),r.on("pointerdown",()=>{this.startGame()});const o=_.getHighScore();this.add.text(e,t+160,`RÉCORD: ${o}`,{fontSize:"16px",fontFamily:a.UI.FONT_FAMILY,color:"#ff00ff"}).setOrigin(.5),this.add.text(e,t+220,"Usa las flechas ← ↑ → ↓ o desliza",{fontSize:"12px",fontFamily:a.UI.FONT_FAMILY,color:"#888888"}).setOrigin(.5);const h=this.add.text(a.GAME_WIDTH-10,10,"DEV",{fontSize:"12px",fontFamily:a.UI.FONT_FAMILY,color:"#666666",backgroundColor:"#222222",padding:{x:8,y:4}});h.setOrigin(1,0),h.setInteractive({useHandCursor:!0}),h.on("pointerover",()=>h.setStyle({color:"#ffffff"})),h.on("pointerout",()=>h.setStyle({color:"#666666"})),h.on("pointerdown",()=>this.toggleDevPanel()),this.input.keyboard.on("keydown-ENTER",()=>this.startGame()),this.input.keyboard.on("keydown-SPACE",()=>this.startGame()),this.input.on("pointerdown",d=>{d.y<t+50||d.y>t+120})}toggleDevPanel(){if(this.devPanel){this.devPanel.destroy(),this.devPanel=null;return}const e=a.GAME_WIDTH/2,t=a.GAME_HEIGHT/2;this.devPanel=this.add.container(e,t);const i=this.add.graphics();i.fillStyle(1710638,.95),i.fillRoundedRect(-150,-130,300,260,10),i.lineStyle(2,5032432),i.strokeRoundedRect(-150,-130,300,260,10),this.devPanel.add(i);const s=this.add.text(0,-110,"DEV MODE",{fontSize:"16px",fontFamily:a.UI.FONT_FAMILY,color:"#4CC9F0"});s.setOrigin(.5),this.devPanel.add(s),[{key:"level",label:"Nivel",min:1,max:50},{key:"shields",label:"Shields",min:0,max:10},{key:"continues",label:"Continues",min:0,max:10},{key:"score",label:"Puntaje",min:0,max:1e4,step:100}].forEach((o,l)=>{const c=-60+l*45,h=this.add.text(-120,c,o.label,{fontSize:"12px",fontFamily:a.UI.FONT_FAMILY,color:"#ffffff"});this.devPanel.add(h);const d=this.add.text(30,c,"-",{fontSize:"20px",fontFamily:a.UI.FONT_FAMILY,color:"#ff6666",backgroundColor:"#330000",padding:{x:10,y:2}});d.setInteractive({useHandCursor:!0}),d.on("pointerdown",()=>{const f=o.step||1;this.devModeData[o.key]=Math.max(o.min,this.devModeData[o.key]-f),this.updateDevText(o.key)}),this.devPanel.add(d);const u=this.add.text(75,c,String(this.devModeData[o.key]),{fontSize:"14px",fontFamily:a.UI.FONT_FAMILY,color:"#00ff00"});u.setOrigin(.5,0),this.devTexts[o.key]=u,this.devPanel.add(u);const g=this.add.text(100,c,"+",{fontSize:"20px",fontFamily:a.UI.FONT_FAMILY,color:"#66ff66",backgroundColor:"#003300",padding:{x:10,y:2}});g.setInteractive({useHandCursor:!0}),g.on("pointerdown",()=>{const f=o.step||1;this.devModeData[o.key]=Math.min(o.max,this.devModeData[o.key]+f),this.updateDevText(o.key)}),this.devPanel.add(g)});const r=this.add.text(0,100,"✓ INICIAR CON ESTOS VALORES",{fontSize:"12px",fontFamily:a.UI.FONT_FAMILY,color:"#00ff00",backgroundColor:"#004400",padding:{x:15,y:8}});r.setOrigin(.5),r.setInteractive({useHandCursor:!0}),r.on("pointerover",()=>r.setStyle({backgroundColor:"#006600"})),r.on("pointerout",()=>r.setStyle({backgroundColor:"#004400"})),r.on("pointerdown",()=>{this.devModeData.enabled=!0,this.startGame()}),this.devPanel.add(r),this.devPanel.setDepth(100)}updateDevText(e){this.devTexts[e]&&this.devTexts[e].setText(String(this.devModeData[e]))}startGame(){this.cameras.main.fadeOut(300,0,0,0),this.time.delayedCall(300,()=>{this.scene.start("GameScene",this.devModeData.enabled?this.devModeData:null)})}}class A{constructor(e){this.desiredDirection={dx:0,dy:0},this.swipeStartX=0,this.swipeStartY=0,this.minSwipeDistance=30,this.scene=e}setup(){this.setupKeyboardControls(),this.setupTouchControls()}setupKeyboardControls(){this.cursors=this.scene.input.keyboard.createCursorKeys(),this.restartKey=this.scene.input.keyboard.addKey(S.Input.Keyboard.KeyCodes.R),this.menuKey=this.scene.input.keyboard.addKey(S.Input.Keyboard.KeyCodes.M),this.continueKey=this.scene.input.keyboard.addKey(S.Input.Keyboard.KeyCodes.C),this.scene.input.keyboard.on("keydown",e=>{switch(e.code){case"ArrowLeft":this.desiredDirection={dx:-1,dy:0};break;case"ArrowRight":this.desiredDirection={dx:1,dy:0};break;case"ArrowUp":this.desiredDirection={dx:0,dy:-1};break;case"ArrowDown":this.desiredDirection={dx:0,dy:1};break;default:return}this.scene.events.emit("input:direction",this.desiredDirection)})}setupTouchControls(){this.scene.input.on("pointerdown",e=>{this.swipeStartX=e.x,this.swipeStartY=e.y}),this.scene.input.on("pointerup",e=>{const t=e.x-this.swipeStartX,i=e.y-this.swipeStartY,s=Math.abs(t),n=Math.abs(i);Math.max(s,n)<this.minSwipeDistance||(s>n?this.desiredDirection={dx:t>0?1:-1,dy:0}:this.desiredDirection={dx:0,dy:i>0?1:-1},this.scene.events.emit("input:direction",this.desiredDirection))})}isRestartJustPressed(){return S.Input.Keyboard.JustDown(this.restartKey)}isMenuJustPressed(){return S.Input.Keyboard.JustDown(this.menuKey)}isContinueJustPressed(){return S.Input.Keyboard.JustDown(this.continueKey)}getDesiredDirection(){return this.desiredDirection}resetDesiredDirection(){this.desiredDirection={dx:0,dy:0}}destroy(){var e;(e=this.scene.input.keyboard)==null||e.off("keydown"),this.scene.input.off("pointerdown"),this.scene.input.off("pointerup")}}class C{constructor(e){this.availableMusicKeys=[],this.backgroundMusic=null,this.musicPlaylistOrder=[],this.currentPlaylistIndex=0,this.scene=e}detectAndLoadMusic(){this.availableMusicKeys=[];const e=a.AUDIO.MAX_BG_TRACKS;this.scene.load.on("loaderror",t=>{if(t.key.startsWith("backgroundMusic")){const i=this.availableMusicKeys.indexOf(t.key);i>-1&&this.availableMusicKeys.splice(i,1)}}),this.scene.load.on("filecomplete",t=>{t.startsWith("backgroundMusic")&&(this.availableMusicKeys.includes(t)||this.availableMusicKeys.push(t))});for(let t=1;t<=e;t++){const s=`bg_${t.toString().padStart(3,"0")}.mp3`,n=`backgroundMusic${t-1}`;if(this.scene.cache.audio.exists(n)){this.availableMusicKeys.includes(n)||this.availableMusicKeys.push(n);continue}try{this.scene.load.audio(n,`sound/bg/${s}`)}catch(r){console.warn("Could not queue music file:",s,r)}}}initMusic(){const e=()=>{this.availableMusicKeys.length>0?(this.shufflePlaylist(),this.playNext()):this.scene.time.delayedCall(500,()=>{this.availableMusicKeys.length>0&&(this.shufflePlaylist(),this.playNext())})};this.scene.sound.locked?(this.scene.input.once("pointerdown",()=>this.scene.sound.unlock()),this.scene.input.keyboard&&this.scene.input.keyboard.once("keydown",()=>this.scene.sound.unlock()),this.scene.sound.once("unlocked",e)):this.scene.time.delayedCall(200,e)}shufflePlaylist(){if(this.availableMusicKeys.length===0){this.musicPlaylistOrder=[],this.currentPlaylistIndex=0;return}this.musicPlaylistOrder=[...this.availableMusicKeys];for(let e=this.musicPlaylistOrder.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[this.musicPlaylistOrder[e],this.musicPlaylistOrder[t]]=[this.musicPlaylistOrder[t],this.musicPlaylistOrder[e]]}this.currentPlaylistIndex=0}playNext(){if(this.availableMusicKeys.length===0)return;this.stop(),this.currentPlaylistIndex>=this.musicPlaylistOrder.length&&this.shufflePlaylist();const e=this.musicPlaylistOrder[this.currentPlaylistIndex];this.currentPlaylistIndex++,this.playSpecific(e)}playPrevious(){this.availableMusicKeys.length!==0&&(this.currentPlaylistIndex=Math.max(0,this.currentPlaylistIndex-2),this.playNext())}playSpecific(e){try{if(!this.scene.cache.audio.exists(e))return;this.backgroundMusic=this.scene.sound.add(e,{loop:!1,volume:a.AUDIO.DEFAULT_VOLUME}),this.backgroundMusic.play(),this.backgroundMusic.once("complete",()=>{this.playNext()})}catch(t){console.error("Error in playSpecific:",t)}}togglePlayPause(){var t,i;const e=this.scene.sound;((t=e==null?void 0:e.context)==null?void 0:t.state)==="suspended"&&e.context.resume().catch(()=>{}),(i=this.backgroundMusic)!=null&&i.isPlaying?this.backgroundMusic.pause():this.backgroundMusic?this.backgroundMusic.resume():this.playNext()}stop(){this.backgroundMusic&&(this.backgroundMusic.stop(),this.backgroundMusic.destroy(),this.backgroundMusic=null)}setVolume(e){this.backgroundMusic&&"setVolume"in this.backgroundMusic&&this.backgroundMusic.setVolume(e)}isPlaying(){var e;return((e=this.backgroundMusic)==null?void 0:e.isPlaying)??!1}destroy(){this.stop(),this.scene.load.off("loaderror"),this.scene.load.off("filecomplete")}}function y(p,e,t){try{if(!t||!t.textures||!t.textures.get(p))return console.warn(`calculateSpriteScale: Invalid texture key "${p}"`),1;const s=t.textures.get(p).getSourceImage(),n=s.width,r=s.height;return Math.min(e/n,e/r)}catch(i){return console.error("Error calculating sprite scale:",i),1}}function v(p=[],e,t){if(Array.isArray(p)||(console.warn("generateFreePosition: excludePositions must be an array"),p=[]),!e||e<1||!t||t<1)return console.error("generateFreePosition: Invalid dimensions:",e,t),null;const i=50;let s=0;for(;s<i;){const n={x:Math.floor(Math.random()*e),y:Math.floor(Math.random()*t)};if(!p.some(o=>o.x===n.x&&o.y===n.y))return n;s++}return console.warn("generateFreePosition: Could not find free position after",i,"attempts"),null}class O{constructor(e,t,i){this.playerPosition={x:0,y:0},this.moveDirection={dx:0,dy:0},this.isMoving=!1,this.playerMoveTween=null,this.playerSprite=null,this.playerDieSprite=null,this.coinParticles=null,this.trailParticles=null,this.getDesiredDirection=null,this.onTurnMove=null,this.currentStepCallback=null,this.scene=e,this.collision=t,this.cellSize=i}setTurnCallbacks(e,t){this.getDesiredDirection=e,this.onTurnMove=t}create(e){this.playerPosition={...e},this.playerSprite=this.scene.add.sprite(e.x*this.cellSize+this.cellSize/2,e.y*this.cellSize+this.cellSize/2,"player_stand"),this.playerSprite.setDepth(10),this.adjustScaleAndRotation(),this.coinParticles=this.scene.add.particles(0,0,"coin",{speed:{min:50,max:150},scale:{start:.4,end:0},lifespan:600,blendMode:"ADD",quantity:10,emitting:!1}),this.trailParticles=this.scene.add.particles(0,0,"player_run",{speed:0,scale:{start:y("player_run",this.cellSize,this.scene)*.9,end:.7},alpha:{start:.15,end:0},lifespan:1e3,blendMode:"ADD",frequency:140,emitting:!1})}move(e,t,i,s,n,r,o){if(this.isMoving||e===0&&t===0)return;this.moveDirection={dx:e,dy:t};const l=this.collision.calculateMoveUntilObstacle(this.playerPosition.x,this.playerPosition.y,e,t);if(l.distance===0){this.resetMovementState();return}this.startMovement(),this.currentStepCallback=o;const c=this.calculateStepDuration(i),h=this.calculateFinalDestination(e,t,l,s,n,r);this.executeMovementTween(e,t,c,h,s,n,r,o)}calculateStepDuration(e){const t=a.PERFORMANCE.PLAYER_BASE_DURATION_MS,i=a.PERFORMANCE.PLAYER_STEP_DEC_PER_LEVEL,s=a.PERFORMANCE.PLAYER_STEP_DEC_SLOW,n=a.PERFORMANCE.PLAYER_STEP_DEC_TINY,r=a.PERFORMANCE.PLAYER_PHASE1_MAX_LEVEL,o=a.PERFORMANCE.PLAYER_PHASE2_MAX_LEVEL,l=a.PERFORMANCE.PLAYER_MIN_STEP_DURATION_MS;let c;if(e<=r)c=t-e*i;else if(e<=o){const h=t-r*i,d=e-r;c=h-d*s}else{const d=t-r*i-(o-r)*s,u=e-o;c=d-u*n}return Math.max(l,c)}calculateFinalDestination(e,t,i,s,n,r){const o=this.playerPosition.x,l=this.playerPosition.y;for(let c=1;c<=i.distance;c++){const h=o+e*c,d=l+t*c;if(this.collision.isTrap(h,d,s))return{x:h,y:d,step:c};if(r(h,d))return{x:h,y:d,step:c};if(h===n.x&&d===n.y)return{x:h,y:d,step:c}}return{x:i.x,y:i.y,step:i.distance}}executeMovementTween(e,t,i,s,n,r,o,l){const c=this.playerPosition.x,h=this.playerPosition.y;let d=-1;this.playerMoveTween=this.scene.tweens.add({targets:this.playerSprite,x:s.x*this.cellSize+this.cellSize/2,y:s.y*this.cellSize+this.cellSize/2,duration:i*s.step,ease:"Linear",onUpdate:u=>{const g=u.progress,f=Math.floor(g*s.step),P=Math.max(0,d+1);for(let M=P;M<=f;M++){const m=c+e*M,x=h+t*M;if(m!==this.playerPosition.x||x!==this.playerPosition.y){if(this.playerPosition.x=m,this.playerPosition.y=x,l(m,x),this.collision.isTrap(m,x,n)||o(m,x)){this.scene.events.emit("player:died");const E=this.scene.gameState;if(E!=null&&E.isGameOver)return}if(m===r.x&&x===r.y){this.scene.events.emit("player:reachedExit");return}if(this.checkTurnOpportunity(u))return}}d=f},onComplete:()=>{this.onMovementComplete(s,n,r)}})}checkTurnOpportunity(e){var i;if(!this.getDesiredDirection||!this.onTurnMove)return!1;const t=this.getDesiredDirection();if((t.dx!==0||t.dy!==0)&&(t.dx!==this.moveDirection.dx||t.dy!==this.moveDirection.dy)){const s=this.playerPosition.x+t.dx,n=this.playerPosition.y+t.dy;if(!this.collision.isCollision(s,n))return(i=this.playerSprite)==null||i.setPosition(this.playerPosition.x*this.cellSize+this.cellSize/2,this.playerPosition.y*this.cellSize+this.cellSize/2),e.stop(),this.isMoving=!1,this.onTurnMove(t.dx,t.dy),!0}return!1}onMovementComplete(e,t,i){var s;if(this.trailParticles&&this.trailParticles.stop(),this.playerPosition.x=e.x,this.playerPosition.y=e.y,e.step>0&&this.scene.cameras.main.shake(100,.005),this.currentStepCallback&&this.currentStepCallback(this.playerPosition.x,this.playerPosition.y),this.collision.isTrap(this.playerPosition.x,this.playerPosition.y,t)){this.scene.events.emit("player:died");const n=this.scene.gameState;if(n!=null&&n.isGameOver)return}if(this.playerPosition.x===i.x&&this.playerPosition.y===i.y){this.scene.events.emit("player:reachedExit");return}this.isMoving=!1,this.playerMoveTween=null,this.moveDirection={dx:0,dy:0},(s=this.playerSprite)==null||s.setTexture("player_stand"),this.adjustScaleAndRotation()}startMovement(){var e;this.isMoving=!0,(e=this.playerSprite)==null||e.setTexture("player_run"),this.adjustScaleAndRotation(),this.trailParticles&&this.playerSprite&&(this.trailParticles.start(),this.trailParticles.startFollow(this.playerSprite))}resetMovementState(){var e;this.moveDirection={dx:0,dy:0},(e=this.playerSprite)==null||e.setTexture("player_stand"),this.adjustScaleAndRotation()}adjustScaleAndRotation(){if(!this.playerSprite)return;const e=y(this.playerSprite.texture.key,this.cellSize,this.scene);this.playerSprite.setScale(e),this.moveDirection.dx===1?(this.playerSprite.setAngle(0),this.playerSprite.setFlipX(!1)):this.moveDirection.dx===-1?(this.playerSprite.setAngle(0),this.playerSprite.setFlipX(!0)):this.moveDirection.dy===-1?(this.playerSprite.setAngle(-90),this.playerSprite.setFlipX(!1)):this.moveDirection.dy===1?(this.playerSprite.setAngle(90),this.playerSprite.setFlipX(!1)):(this.playerSprite.setAngle(0),this.playerSprite.setFlipX(!1))}emitCoinParticles(e,t){this.coinParticles&&this.coinParticles.emitParticleAt(e*this.cellSize+this.cellSize/2,t*this.cellSize+this.cellSize/2)}flashInvincibility(){this.playerSprite&&(this.scene.tweens.add({targets:this.playerSprite,alpha:{from:1,to:.3},duration:80,yoyo:!0,repeat:4,onComplete:()=>{var e;(e=this.playerSprite)==null||e.setAlpha(1)}}),this.playerSprite.setTint(49151),this.scene.time.delayedCall(400,()=>{var e;(e=this.playerSprite)==null||e.clearTint()}))}showDeathSprite(){this.playerSprite&&(this.playerSprite.destroy(),this.playerSprite=null),this.playerDieSprite=this.scene.add.sprite(this.playerPosition.x*this.cellSize+this.cellSize/2,this.playerPosition.y*this.cellSize+this.cellSize/2,"player_die");const e=y("player_die",this.cellSize,this.scene);this.playerDieSprite.setScale(e)}stopMovement(){this.playerMoveTween&&(this.playerMoveTween.stop(),this.playerMoveTween=null),this.isMoving=!1,this.moveDirection={dx:0,dy:0},this.trailParticles&&this.trailParticles.stop()}reset(e){this.playerPosition={...e},this.isMoving=!1,this.moveDirection={dx:0,dy:0},this.playerMoveTween&&(this.playerMoveTween.stop(),this.playerMoveTween=null),this.playerDieSprite&&(this.playerDieSprite.destroy(),this.playerDieSprite=null),this.playerSprite?(this.playerSprite.setPosition(e.x*this.cellSize+this.cellSize/2,e.y*this.cellSize+this.cellSize/2),this.playerSprite.setVisible(!0),this.playerSprite.setTexture("player_stand")):(this.playerSprite=this.scene.add.sprite(e.x*this.cellSize+this.cellSize/2,e.y*this.cellSize+this.cellSize/2,"player_stand"),this.playerSprite.setDepth(10)),this.adjustScaleAndRotation()}getPosition(){return{...this.playerPosition}}getMoveDirection(){return{...this.moveDirection}}getIsMoving(){return this.isMoving}getSprite(){return this.playerSprite}destroy(){this.stopMovement(),this.playerSprite&&this.playerSprite.destroy(),this.playerDieSprite&&this.playerDieSprite.destroy(),this.coinParticles&&this.coinParticles.destroy(),this.trailParticles&&this.trailParticles.destroy()}}class D{constructor(e,t,i){this.enemies=[],this.scene=e,this.collision=t,this.cellSize=i}init(e,t){if(this.reset(),e<a.ENEMIES.FIRST_SPAWN_LEVEL)return;let i=1;const s=a.ENEMIES.FIRST_SPAWN_LEVEL+a.ENEMIES.SECOND_ENEMY_INTERVAL;e>=s&&(i=1+Math.floor((e-a.ENEMIES.FIRST_SPAWN_LEVEL)/a.ENEMIES.SECOND_ENEMY_INTERVAL)),i=Math.min(i,a.ENEMIES.MAX_COUNT);const{width:n,height:r}=this.collision.getBoardDimensions();for(let o=0;o<i;o++){const l=[...t,...this.enemies.map(u=>({x:u.x,y:u.y}))],c=v(l,n,r);if(!c)continue;const h={x:c.x,y:c.y,direction:this.getRandomDirection(),moving:!1,sprite:null};h.sprite=this.scene.add.sprite(h.x*this.cellSize+this.cellSize/2,h.y*this.cellSize+this.cellSize/2,"enemy");const d=y("enemy",this.cellSize,this.scene);h.sprite.setScale(d),h.sprite.setFlipX(h.direction.dx===-1),this.enemies.push(h)}}update(){this.enemies.forEach((e,t)=>{if(e!=null&&e.sprite&&!e.moving){e.moving=!0;const i=e.x+e.direction.dx,s=e.y+e.direction.dy,n=this.collision.isCollision(i,s),r=this.checkEnemyAtPosition(i,s,t);n||r?(e.direction=this.getRandomDirection(),e.moving=!1,e.sprite.setFlipX(e.direction.dx===-1)):this.scene.tweens.add({targets:e.sprite,x:i*this.cellSize+this.cellSize/2,y:s*this.cellSize+this.cellSize/2,duration:a.ENEMIES.MOVE_TWEEN_DURATION_MS,onComplete:()=>{e.x=i,e.y=s,e.moving=!1,this.scene.events.emit("enemy:moved",{x:e.x,y:e.y})}})}})}checkEnemyAtPosition(e,t,i){return this.enemies.some((s,n)=>n===i?!1:Math.round(s.x)===e&&Math.round(s.y)===t)}checkCollision(e,t){return this.enemies.some(i=>Math.round(i.x)===e&&Math.round(i.y)===t)}getRandomDirection(){const e=[{dx:0,dy:-1},{dx:1,dy:0},{dx:0,dy:1},{dx:-1,dy:0}];return e[S.Math.Between(0,e.length-1)]}getEnemies(){return this.enemies}updateSprites(){this.enemies.forEach(e=>{e.sprite&&(e.direction.dx===-1?e.sprite.setFlipX(!0):e.direction.dx===1&&e.sprite.setFlipX(!1))})}reset(){this.enemies.forEach(e=>{e!=null&&e.sprite&&e.sprite.destroy()}),this.enemies=[]}destroy(){this.reset()}}class z{constructor(e,t,i,s,n){this.spiders=[],this.obstacles=[],this.scene=e,this.collision=t,this.cellSize=i,this.width=s,this.height=n}generate(e,t,i){if(this.reset(),this.obstacles=t,!this.width||!this.height)return;let s=0;if(e<a.SPIDER.FIRST_SPAWN_LEVEL?s=0:e<a.SPIDER.SECOND_SPAWN_LEVEL?s=1:e<a.SPIDER.THIRD_SPAWN_LEVEL?s=2:s=3,s!==0)for(let n=0;n<s;n++){let r=0,o=!1;for(;!o&&r<50;){r++;const l={x:S.Math.Between(0,this.width-1),y:S.Math.Between(0,this.height-1)};if(!this.isValidPoint(l,i))continue;const c=S.Math.Between(0,1),h={x:l.x,y:l.y};if(c===0?h.x=S.Math.Between(0,this.width-1):h.y=S.Math.Between(0,this.height-1),Math.abs(h.x-l.x+(h.y-l.y))<a.SPIDER.MIN_PATROL_DISTANCE||!this.isValidPoint(h,i)||!this.collision.isPathClear(l,h,this.obstacles))continue;const u={state:"WAITING",pointA:{...l},pointB:{...h},currentTarget:{...h},x:l.x,y:l.y,waitStartTime:this.scene.time.now,sprite:null};u.sprite=this.scene.add.sprite(u.x*this.cellSize+this.cellSize/2,u.y*this.cellSize+this.cellSize/2,"spider");const g=y("spider",this.cellSize,this.scene);u.sprite.setScale(g),this.spiders.push(u),o=!0}}}update(e,t){let i=!1;return this.spiders.forEach(s=>{if(s.sprite){if(Math.round(s.x)===t.x&&Math.round(s.y)===t.y&&(i=!0),s.state==="WAITING")e-s.waitStartTime>a.SPIDER.WAIT_DURATION_MS&&(s.state="MOVING");else if(s.state==="MOVING"){const n=s.currentTarget.x-s.x,r=s.currentTarget.y-s.y,o=a.SPIDER.MOVE_SPEED;Math.abs(n)<o&&Math.abs(r)<o?(s.x=s.currentTarget.x,s.y=s.currentTarget.y,s.sprite.setPosition(s.x*this.cellSize+this.cellSize/2,s.y*this.cellSize+this.cellSize/2),s.state="WAITING",s.waitStartTime=e,s.currentTarget.x===s.pointA.x&&s.currentTarget.y===s.pointA.y?s.currentTarget={...s.pointB}:s.currentTarget={...s.pointA}):(s.x+=Math.sign(n)*o,s.y+=Math.sign(r)*o,s.sprite.setPosition(s.x*this.cellSize+this.cellSize/2,s.y*this.cellSize+this.cellSize/2))}}}),i}isValidPoint(e,t){return!(e.x<0||e.x>=this.width||e.y<0||e.y>=this.height||e.x===0&&e.y===0||e.x===t.x&&e.y===t.y||this.obstacles.some(i=>i.x===e.x&&i.y===e.y))}checkCollision(e,t){return this.spiders.some(i=>Math.round(i.x)===e&&Math.round(i.y)===t)}getSpiders(){return this.spiders}reset(){this.spiders.forEach(e=>{e.sprite&&e.sprite.destroy()}),this.spiders=[]}destroy(){this.reset()}}class w{constructor(){this.eventListenerCleanup=[],this.toggleMusicButton=null}updateScore(e){const t=typeof e=="number"&&!isNaN(e)?e:0,i=document.getElementById("score");i&&(i.textContent="Puntos: "+t)}updateLevel(e){const t=typeof e=="number"&&!isNaN(e)?e:1,i=document.getElementById("level");i&&(i.textContent="Nivel: "+t)}updatePowerUps(e,t){const i=document.getElementById("shields"),s=document.getElementById("continues");i&&(i.textContent="S: "+e,i.style.opacity=e>0?"1":"0.4"),s&&(s.textContent="C: "+t,s.style.opacity=t>0?"1":"0.4")}updateScoreAndLevel(e,t){this.updateScore(e),this.updateLevel(t)}updateAll(e,t,i,s){this.updateScore(e),this.updateLevel(t),this.updatePowerUps(i,s)}updateMusicButtonState(e){this.toggleMusicButton&&(e?(this.toggleMusicButton.textContent="❚❚",this.toggleMusicButton.classList.add("playing")):(this.toggleMusicButton.textContent="▶",this.toggleMusicButton.classList.remove("playing")))}setupEventListeners(e){this.cleanup(),this.toggleMusicButton=document.getElementById("toggle-music");const t=document.getElementById("stop-music"),i=document.getElementById("volume-slider"),s=document.getElementById("next-music"),n=document.getElementById("menu-button"),r=document.getElementById("continue-button"),o=document.getElementById("restart-button"),l=(c,h,d)=>{c&&(c.addEventListener(h,d),this.eventListenerCleanup.push({element:c,event:h,handler:d}))};l(this.toggleMusicButton,"click",()=>{e.onMusicToggle()}),l(t,"click",()=>{e.onMusicStop()}),l(i,"input",c=>{const h=c.target;e.onVolumeChange(parseFloat(h.value))}),l(s,"click",()=>{e.onNextMusic()}),l(n,"click",()=>{e.onMenu()}),l(r,"click",()=>{e.onContinue()}),l(o,"click",()=>{e.onRestart()})}cleanup(){this.eventListenerCleanup.forEach(({element:e,event:t,handler:i})=>{e&&e.removeEventListener(t,i)}),this.eventListenerCleanup=[]}destroy(){this.cleanup()}}class R{constructor(e){this._gameOver=!1,this._level=1,this._score=0,this._initialCoinCount=0,this._shieldCount=0,this._continueCount=0,this.gameOverText=null,this.restartText=null,this.continueText=null,this.newRecordText=null,this.menuText=null,this.scene=e}createGameOverUI(){this.gameOverText=this.scene.add.text(a.GAME_WIDTH/2,a.GAME_HEIGHT/2,"GAME OVER",{fontSize:a.UI.GAME_OVER_FONT_SIZE,fontFamily:a.UI.FONT_FAMILY,color:"#ff0000",stroke:"#ffffff",strokeThickness:4}),this.gameOverText.setOrigin(.5),this.gameOverText.setDepth(100),this.gameOverText.setVisible(!1),this.restartText=this.scene.add.text(a.GAME_WIDTH/2,a.GAME_HEIGHT/2+a.UI.RESTART_OFFSET_Y,"PRESS R TO RESTART",{fontSize:a.UI.RESTART_FONT_SIZE,fontFamily:a.UI.FONT_FAMILY,color:"#ffff00",align:"center"}),this.restartText.setOrigin(.5),this.restartText.setDepth(100),this.restartText.setVisible(!1)}showGameOver(){var i,s,n;this._gameOver=!0;const e=_.setHighScore(this._score);(i=this.gameOverText)==null||i.setVisible(!0),(s=this.restartText)==null||s.setVisible(!0),this._continueCount>0?(this.continueText||(this.continueText=this.scene.add.text(a.GAME_WIDTH/2,a.GAME_HEIGHT/2+a.UI.RESTART_OFFSET_Y+25,"",{fontSize:"14px",fontFamily:a.UI.FONT_FAMILY,color:"#00ff00"}),this.continueText.setOrigin(.5),this.continueText.setDepth(100)),this.continueText.setText(`C PARA CONTINUAR (${this._continueCount}❤)`),this.continueText.setVisible(!0)):(n=this.continueText)==null||n.setVisible(!1),e&&this._score>0&&(this.newRecordText||(this.newRecordText=this.scene.add.text(a.GAME_WIDTH/2,a.GAME_HEIGHT/2-60,"¡NUEVO RÉCORD!",{fontSize:"20px",fontFamily:a.UI.FONT_FAMILY,color:"#ffff00",stroke:"#ff6600",strokeThickness:3}),this.newRecordText.setOrigin(.5),this.newRecordText.setDepth(100)),this.newRecordText.setVisible(!0),this.scene.tweens.add({targets:this.newRecordText,scaleX:1.2,scaleY:1.2,duration:400,yoyo:!0,repeat:-1}));const t=this._continueCount>0?a.UI.RESTART_OFFSET_Y+55:a.UI.RESTART_OFFSET_Y+30;this.menuText?this.menuText.setY(a.GAME_HEIGHT/2+t):(this.menuText=this.scene.add.text(a.GAME_WIDTH/2,a.GAME_HEIGHT/2+t,"PRESIONA M PARA MENÚ",{fontSize:"14px",fontFamily:a.UI.FONT_FAMILY,color:"#888888"}),this.menuText.setOrigin(.5),this.menuText.setDepth(100)),this.menuText.setVisible(!0)}hideGameOverUI(){var e,t,i,s,n;(e=this.gameOverText)==null||e.setVisible(!1),(t=this.restartText)==null||t.setVisible(!1),(i=this.continueText)==null||i.setVisible(!1),(s=this.newRecordText)==null||s.setVisible(!1),(n=this.menuText)==null||n.setVisible(!1)}addScore(e){this._score+=e}nextLevel(){this._score+=100,this._level+=1}addShield(){this._shieldCount++}useShield(){return this._shieldCount>0?(this._shieldCount--,!0):!1}addContinue(){this._continueCount++}useContinue(){return this._continueCount>0?(this._continueCount--,!0):!1}hasShield(){return this._shieldCount>0}hasContinue(){return this._continueCount>0}reset(e){e&&(this._level=1,this._score=0,this._shieldCount=0,this._continueCount=0),this._gameOver=!1,this.hideGameOverUI()}applyDevMode(e,t,i,s){this._level=e,this._shieldCount=t,this._continueCount=i,this._score=s}returnToMenu(){this.scene.cameras.main.fadeOut(300,0,0,0),this.scene.time.delayedCall(300,()=>{this.scene.scene.start("MenuScene")})}get isGameOver(){return this._gameOver}set isGameOver(e){this._gameOver=e}get level(){return this._level}get score(){return this._score}get shieldCount(){return this._shieldCount}get continueCount(){return this._continueCount}get initialCoinCount(){return this._initialCoinCount}set initialCoinCount(e){this._initialCoinCount=e}destroy(){this.gameOverText&&this.gameOverText.destroy(),this.restartText&&this.restartText.destroy(),this.continueText&&this.continueText.destroy(),this.newRecordText&&this.newRecordText.destroy(),this.menuText&&this.menuText.destroy()}}class b{constructor(e,t){this.collisionMap=null,this.width=e,this.height=t}build(e){if(!this.width||this.width<1||!this.height||this.height<1){console.error("CollisionSystem.build: Invalid dimensions:",this.width,this.height);return}try{this.collisionMap=Array.from({length:this.height},()=>Array(this.width).fill(!1)),e.forEach(t=>{this.isWithinBounds(t.x,t.y)&&(this.collisionMap[t.y][t.x]=!0)})}catch(t){console.error("Error building collision map:",t),this.collisionMap=Array.from({length:this.height},()=>Array(this.width).fill(!1))}}isCollision(e,t){var i,s;return this.isOutOfBounds(e,t)?!0:((s=(i=this.collisionMap)==null?void 0:i[t])==null?void 0:s[e])??!1}isTrap(e,t,i){return this.isOutOfBounds(e,t)?!1:i.some(s=>s.x===e&&s.y===t)}isOutOfBounds(e,t){return e<0||e>=this.width||t<0||t>=this.height}isWithinBounds(e,t){return e>=0&&e<this.width&&t>=0&&t<this.height}calculateMoveUntilObstacle(e,t,i,s){let n=e,r=t,o=0;for(;;){const l=n+i,c=r+s;if(this.isCollision(l,c))break;n=l,r=c,o++}return{x:n,y:r,distance:o}}isPathClear(e,t,i){const s=Math.sign(t.x-e.x),n=Math.sign(t.y-e.y);let r=e.x,o=e.y;for(;r!==t.x||o!==t.y;)if(r+=s,o+=n,i.some(l=>l.x===r&&l.y===o))return!1;return!0}setBoardDimensions(e,t){this.width=e,this.height=t,this.collisionMap=null}getBoardDimensions(){return{width:this.width,height:this.height}}}class N{constructor(e,t){this.width=e,this.height=t}generate(e){const t={x:0,y:0};let i=0;const s=a.MAZE_GENERATION.MAX_ATTEMPTS;let n;do i++,n=this.generateAttempt(t,e);while(!this.isSolvable(t,e,n)&&i<s);return i>=s?(console.warn("MazeGenerator: Max attempts reached, generating simple maze"),this.generateSimpleMaze(e)):n}generateRandomExit(){return Math.floor(Math.random()*2)===0?{x:this.width-1,y:Math.floor(Math.random()*this.height)}:{x:Math.floor(Math.random()*this.width),y:this.height-1}}generateSaveItem(e){return v(e,this.width,this.height)}generateAttempt(e,t){const i=[],s=[],n=[];for(let r=0;r<this.height;r++)for(let o=0;o<this.width;o++)if(!(o===e.x&&r===e.y||o===t.x&&r===t.y))if(Math.random()<a.MAZE_GENERATION.OBSTACLE_PROBABILITY&&this.hasEnoughSpace(o,r,s,n)){const l=["brick","rock","tree"],c=l[S.Math.Between(0,l.length-1)];s.push({x:o,y:r,type:c})}else Math.random()<a.MAZE_GENERATION.COIN_PROBABILITY?i.push({x:o,y:r}):Math.random()<a.MAZE_GENERATION.TRAP_PROBABILITY&&this.hasEnoughSpace(o,r,s,n)&&n.push({x:o,y:r});return{coins:i,obstacles:s,traps:n,exitPosition:t}}hasEnoughSpace(e,t,i,s){const n=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0},{x:-1,y:-1},{x:1,y:-1},{x:-1,y:1},{x:1,y:1}];let r=0;for(const o of n){const l=e+o.x,c=t+o.y;l>=0&&l<this.width&&c>=0&&c<this.height&&!i.some(h=>h.x===l&&h.y===c)&&!s.some(h=>h.x===l&&h.y===c)&&r++}return r>=a.MAZE_GENERATION.MIN_FREE_SPACES}isSolvable(e,t,i){const s=[{x:e.x,y:e.y}],n=Array.from({length:this.height},()=>Array(this.width).fill(!1));n[e.y][e.x]=!0;const r=[{x:0,y:-1},{x:1,y:0},{x:0,y:1},{x:-1,y:0}];for(;s.length>0;){const{x:o,y:l}=s.shift();if(o===t.x&&l===t.y)return!0;for(const c of r){const h=o+c.x,d=l+c.y;h>=0&&h<this.width&&d>=0&&d<this.height&&!n[d][h]&&!i.obstacles.some(u=>u.x===h&&u.y===d)&&!i.traps.some(u=>u.x===h&&u.y===d)&&(n[d][h]=!0,s.push({x:h,y:d}))}}return!1}generateSimpleMaze(e){return{coins:[{x:2,y:2},{x:5,y:5},{x:7,y:3}],obstacles:[{x:3,y:4,type:"brick"},{x:6,y:7,type:"rock"}],traps:[],exitPosition:e}}setBoardDimensions(e,t){this.width=e,this.height=t}}class L{constructor(e,t,i,s){this.gridGroup=null,this.spriteCache={coins:[],obstacles:[],traps:[]},this.coinSprites=[],this.obstacleSprites=[],this.trapSprites=[],this.exitSprite=null,this.saveSprite=null,this.shieldSprite=null,this.exitPulseTween=null,this.savePulseTween=null,this.shieldPulseTween=null,this.scene=e,this.cellSize=t,this.width=i,this.height=s}createGrid(e){var s;this.scene.cameras.main.setBackgroundColor(a.UI.MAIN_BACKGROUND_COLOR);const t=a.BACKGROUND_COLORS[(e-1)%a.BACKGROUND_COLORS.length];(s=this.gridGroup)!=null&&s.children?this.gridGroup.clear(!0,!0):this.gridGroup=this.scene.add.group();const i=this.scene.add.graphics();i.lineStyle(1,t,a.GRID_ALPHA);for(let n=0;n<=this.width;n++)i.moveTo(n*this.cellSize,0),i.lineTo(n*this.cellSize,this.height*this.cellSize);for(let n=0;n<=this.height;n++)i.moveTo(0,n*this.cellSize),i.lineTo(this.width*this.cellSize,n*this.cellSize);i.strokePath(),this.gridGroup.add(i);for(let n=0;n<this.height;n++)for(let r=0;r<this.width;r++){const o=this.scene.add.rectangle(r*this.cellSize+this.cellSize/2,n*this.cellSize+this.cellSize/2,2,2,t);o.setAlpha(.6),this.gridGroup.add(o)}}drawEntities(e){this.drawExit(e.exitPosition),this.drawCoins(e.coins),this.drawObstacles(e.obstacles),this.drawTraps(e.traps),this.drawSave(e.saves),this.drawShield(e.shields),this.hideUnusedSprites()}drawExit(e){this.exitSprite?(this.exitSprite.setPosition(e.x*this.cellSize+this.cellSize/2,e.y*this.cellSize+this.cellSize/2),this.exitSprite.setVisible(!0)):this.exitSprite=this.scene.add.sprite(e.x*this.cellSize+this.cellSize/2,e.y*this.cellSize+this.cellSize/2,"exit");const t=y("exit",this.cellSize,this.scene);this.exitSprite.setScale(t),this.startExitAnimation(t)}startExitAnimation(e){this.exitSprite&&(this.exitPulseTween&&this.exitPulseTween.stop(),this.exitPulseTween=this.scene.tweens.add({targets:this.exitSprite,scaleX:{from:e*.95,to:e*1.1},scaleY:{from:e*.95,to:e*1.1},alpha:{from:.7,to:1},duration:800,ease:"Sine.InOut",yoyo:!0,repeat:-1}))}drawCoins(e){this.coinSprites=[],e.forEach((t,i)=>{var n;let s;if((n=this.spriteCache.coins[i])!=null&&n.active)s=this.spriteCache.coins[i],s.setPosition(t.x*this.cellSize+this.cellSize/2,t.y*this.cellSize+this.cellSize/2),s.setVisible(!0);else{s=this.scene.add.sprite(t.x*this.cellSize+this.cellSize/2,t.y*this.cellSize+this.cellSize/2,"coin");const r=y("coin",this.cellSize,this.scene);s.setScale(r),this.spriteCache.coins[i]=s}s.gridX=t.x,s.gridY=t.y,this.coinSprites.push(s)})}drawObstacles(e){this.obstacleSprites=[],e.forEach((t,i)=>{var n;let s;if((n=this.spriteCache.obstacles[i])!=null&&n.active)s=this.spriteCache.obstacles[i],s.setPosition(t.x*this.cellSize+this.cellSize/2,t.y*this.cellSize+this.cellSize/2),s.setTexture(`obstacle_${t.type}`),s.setVisible(!0);else{s=this.scene.add.sprite(t.x*this.cellSize+this.cellSize/2,t.y*this.cellSize+this.cellSize/2,`obstacle_${t.type}`);const r=y(`obstacle_${t.type}`,this.cellSize,this.scene);s.setScale(r),this.spriteCache.obstacles[i]=s}s.obstacleType=t.type,s.gridX=t.x,s.gridY=t.y,this.obstacleSprites.push(s)})}drawTraps(e){this.trapSprites=[],e.forEach((t,i)=>{var r;let s;if((r=this.spriteCache.traps[i])!=null&&r.active)s=this.spriteCache.traps[i],s.setPosition(t.x*this.cellSize+this.cellSize/2,t.y*this.cellSize+this.cellSize/2),s.setVisible(!0);else{s=this.scene.add.sprite(t.x*this.cellSize+this.cellSize/2,t.y*this.cellSize+this.cellSize/2,"trap");const o=y("trap",this.cellSize,this.scene);s.setScale(o),this.spriteCache.traps[i]=s}const n=S.Math.Between(0,2e3);this.scene.time.delayedCall(n,()=>{s!=null&&s.active&&this.scene.tweens.add({targets:s,angle:360,duration:1500,ease:"Cubic.InOut",repeat:-1,onRepeat:()=>s.setAngle(0)})}),this.trapSprites.push(s)})}drawSave(e){if(e.length>0){const t=e[0];this.saveSprite?(this.saveSprite.setPosition(t.x*this.cellSize+this.cellSize/2,t.y*this.cellSize+this.cellSize/2),this.saveSprite.setVisible(!0)):this.saveSprite=this.scene.add.sprite(t.x*this.cellSize+this.cellSize/2,t.y*this.cellSize+this.cellSize/2,"power_continue");const i=y("power_continue",this.cellSize,this.scene);this.saveSprite.setScale(i),this.saveSprite.setAlpha(1),this.savePulseTween&&this.savePulseTween.stop(),this.savePulseTween=this.scene.tweens.add({targets:this.saveSprite,scaleX:{from:i*.95,to:i*1.08},scaleY:{from:i*.95,to:i*1.08},alpha:{from:.9,to:1},ease:"Sine.InOut",duration:600,yoyo:!0,repeat:-1})}else this.saveSprite&&this.saveSprite.setVisible(!1)}drawShield(e){if(e.length>0){const t=e[0];this.shieldSprite?(this.shieldSprite.setPosition(t.x*this.cellSize+this.cellSize/2,t.y*this.cellSize+this.cellSize/2),this.shieldSprite.setVisible(!0)):this.shieldSprite=this.scene.add.sprite(t.x*this.cellSize+this.cellSize/2,t.y*this.cellSize+this.cellSize/2,"power_shield");const i=y("power_shield",this.cellSize,this.scene);this.shieldSprite.setScale(i),this.shieldSprite.setAlpha(1),this.shieldPulseTween&&this.shieldPulseTween.stop(),this.shieldPulseTween=this.scene.tweens.add({targets:this.shieldSprite,scaleX:{from:i*.95,to:i*1.08},scaleY:{from:i*.95,to:i*1.08},alpha:{from:.9,to:1},ease:"Sine.InOut",duration:600,yoyo:!0,repeat:-1})}else this.shieldSprite&&this.shieldSprite.setVisible(!1)}hideUnusedSprites(){this.hideUnused(this.coinSprites,"coins"),this.hideUnused(this.obstacleSprites,"obstacles"),this.hideUnused(this.trapSprites,"traps")}hideUnused(e,t){const i=this.spriteCache[t];for(let s=e.length;s<i.length;s++)i[s]&&i[s].setVisible(!1)}animateNearbyTrees(e,t){this.obstacleSprites.forEach(i=>{if(i.obstacleType!=="tree")return;const s=Math.abs((i.gridX??0)-e),n=Math.abs((i.gridY??0)-t);if(s<=1&&n<=1&&s+n>0&&!i.isSwaying){i.isSwaying=!0;const r=e<(i.gridX??0)?-1:1;this.scene.tweens.add({targets:i,angle:{from:0,to:r*8},duration:150,ease:"Sine.InOut",yoyo:!0,repeat:1,onComplete:()=>{i.setAngle(0),i.isSwaying=!1}})}})}removeCoin(e,t){for(let i=this.coinSprites.length-1;i>=0;i--)if(this.coinSprites[i].gridX===e&&this.coinSprites[i].gridY===t){this.coinSprites[i].destroy(),this.coinSprites.splice(i,1);break}}removeSave(){this.savePulseTween&&(this.savePulseTween.stop(),this.savePulseTween=null),this.saveSprite&&(this.saveSprite.destroy(),this.saveSprite=null)}removeShield(){this.shieldPulseTween&&(this.shieldPulseTween.stop(),this.shieldPulseTween=null),this.shieldSprite&&(this.shieldSprite.destroy(),this.shieldSprite=null)}getCoinSprites(){return this.coinSprites}getObstacleSprites(){return this.obstacleSprites}clearCache(){Object.keys(this.spriteCache).forEach(e=>{const t=e;this.spriteCache[t].forEach(i=>{i!=null&&i.destroy&&i.destroy()}),this.spriteCache[t]=[]})}destroy(){this.clearCache(),this.exitPulseTween&&this.exitPulseTween.stop(),this.savePulseTween&&this.savePulseTween.stop(),this.shieldPulseTween&&this.shieldPulseTween.stop(),this.exitSprite&&this.exitSprite.destroy(),this.saveSprite&&this.saveSprite.destroy(),this.shieldSprite&&this.shieldSprite.destroy(),this.gridGroup&&this.gridGroup.clear(!0,!0)}}class G extends S.Scene{constructor(){super("GameScene"),this.saves=[],this.shields=[],this.playerStartPosition={x:0,y:0},this.shieldSpawned=!1,this.continueSpawned=!1,this.lastEnemyUpdateTime=0,this.requireFreshPressAfterReset=!1,this.invincibilityEndTime=0,this.boardWidth=a.BOARD_WIDTH,this.boardHeight=a.BOARD_HEIGHT,this.cellSize=a.CELL_SIZE}preload(){try{this.load.image("player_stand","lucy_stand.png"),this.load.image("player_run","lucy_run.png"),this.load.image("player_die","lucy_die.png"),this.load.image("coin","coin_tuto.png"),this.load.image("obstacle_brick","brick_1.png"),this.load.image("obstacle_rock","rock_1.png"),this.load.image("obstacle_tree","tree_1.png"),this.load.image("trap","sping.png"),this.load.image("exit","exit.png"),this.load.image("enemy","enemy.png"),this.load.image("spider","enemy_spider.png"),this.load.image("power_continue","power_continue.png"),this.load.image("power_shield","power_shield.png"),this.audioManager=new C(this),this.audioManager.detectAndLoadMusic()}catch(e){console.error("Critical error in preload:",e)}}create(e){this.initializeManagers(),e&&e.enabled&&this.gameState.applyDevMode(e.level,e.shields,e.continues,e.score),this.setupEvents(),this.startNewGame(),this.audioManager.initMusic(),this.uiManager.setupEventListeners({onMusicToggle:()=>{this.audioManager.togglePlayPause(),this.uiManager.updateMusicButtonState(this.audioManager.isPlaying())},onMusicStop:()=>{this.audioManager.stop(),this.uiManager.updateMusicButtonState(!1)},onVolumeChange:t=>this.audioManager.setVolume(t),onNextMusic:()=>{this.audioManager.playNext(),this.uiManager.updateMusicButtonState(this.audioManager.isPlaying())},onMenu:()=>this.returnToMenu(),onContinue:()=>this.handleContinueButton(),onRestart:()=>this.handleRestartButton()}),this.uiManager.updateScoreAndLevel(this.gameState.score,this.gameState.level),this.updatePowerUpsUI()}update(e,t){if(this.inputManager.isMenuJustPressed()){this.returnToMenu();return}if(this.inputManager.isRestartJustPressed()){this.handleRestartButton();return}if(this.gameState.isGameOver){this.inputManager.isContinueJustPressed()&&this.handleContinueButton();return}if(e>this.lastEnemyUpdateTime+a.PERFORMANCE.ENEMY_UPDATE_THROTTLE_MS){this.enemyManager.update();const i=this.playerController.getPosition();this.spiderManager.update(e,i)&&!this.gameState.isGameOver&&this.handleDeath(),this.lastEnemyUpdateTime=e}}initializeManagers(){this.collision=new b(this.boardWidth,this.boardHeight),this.mazeGenerator=new N(this.boardWidth,this.boardHeight),this.gridRenderer=new L(this,this.cellSize,this.boardWidth,this.boardHeight),this.inputManager=new A(this),this.playerController=new O(this,this.collision,this.cellSize),this.enemyManager=new D(this,this.collision,this.cellSize),this.spiderManager=new z(this,this.collision,this.cellSize,this.boardWidth,this.boardHeight),this.uiManager=new w,this.gameState=new R(this),this.inputManager.setup(),this.playerController.setTurnCallbacks(()=>this.inputManager.getDesiredDirection(),(e,t)=>this.handlePlayerMove({dx:e,dy:t})),this.gameState.createGameOverUI()}setupEvents(){this.events.on("input:direction",e=>{!this.playerController.getIsMoving()&&!this.gameState.isGameOver&&(e.dx!==0||e.dy!==0)&&(this.handlePlayerMove(e),this.requireFreshPressAfterReset=!1)}),this.events.on("player:died",()=>{this.handleDeath()}),this.events.on("player:reachedExit",()=>{this.handleLevelComplete()}),this.events.on("enemy:moved",e=>{const t=this.playerController.getPosition();e.x===t.x&&e.y===t.y&&this.handleDeath()})}startNewGame(){const e=this.mazeGenerator.generateRandomExit();this.mazeData=this.mazeGenerator.generate(e),this.saves=[],this.collision.build(this.mazeData.obstacles),this.gameState.initialCoinCount=this.mazeData.coins.length,this.gridRenderer.createGrid(this.gameState.level),this.gridRenderer.drawEntities({coins:this.mazeData.coins,obstacles:this.mazeData.obstacles,traps:this.mazeData.traps,saves:this.saves,shields:this.shields,exitPosition:this.mazeData.exitPosition}),this.playerController.create(this.playerStartPosition);const t=[this.playerStartPosition,this.mazeData.exitPosition,...this.mazeData.obstacles,...this.mazeData.traps];this.enemyManager.init(this.gameState.level,t),this.spiderManager.generate(this.gameState.level,this.mazeData.obstacles,this.mazeData.exitPosition)}handlePlayerMove(e){this.playerController.move(e.dx,e.dy,this.gameState.level,this.mazeData.traps,this.mazeData.exitPosition,(t,i)=>this.enemyManager.checkCollision(t,i)||this.spiderManager.checkCollision(t,i),(t,i)=>this.processItemsAtPosition(t,i))}processItemsAtPosition(e,t){for(let i=this.mazeData.coins.length-1;i>=0;i--)if(this.mazeData.coins[i].x===e&&this.mazeData.coins[i].y===t){this.playerController.emitCoinParticles(e,t),this.mazeData.coins.splice(i,1),this.gameState.addScore(10),this.uiManager.updateScore(this.gameState.score),this.gridRenderer.removeCoin(e,t),this.gameState.initialCoinCount>0&&(this.gameState.initialCoinCount-this.mazeData.coins.length)/this.gameState.initialCoinCount>=a.POWERUPS.SPAWN_COIN_RATIO&&!this.shieldSpawned&&!this.continueSpawned&&(Math.random()<a.POWERUPS.SHIELD_PROBABILITY?(this.generateShieldItem(),this.shieldSpawned=!0):(this.generateSaveItem(),this.continueSpawned=!0));break}if(this.shields.length>0){const i=this.shields[0];i.x===e&&i.y===t&&(this.gameState.addShield(),this.shields.splice(0,1),this.gridRenderer.removeShield(),this.updatePowerUpsUI())}if(this.saves.length>0){const i=this.saves[0];i.x===e&&i.y===t&&(this.gameState.addContinue(),this.saves.splice(0,1),this.gridRenderer.removeSave(),this.updatePowerUpsUI())}this.gridRenderer.animateNearbyTrees(e,t)}generateSaveItem(){const e=[this.playerController.getPosition(),this.mazeData.exitPosition,...this.mazeData.obstacles,...this.mazeData.traps,...this.enemyManager.getEnemies().map(i=>({x:i.x,y:i.y})),...this.shields],t=this.mazeGenerator.generateSaveItem(e);t&&this.saves.length===0&&(this.saves.push(t),this.gridRenderer.drawEntities({coins:this.mazeData.coins,obstacles:this.mazeData.obstacles,traps:this.mazeData.traps,saves:this.saves,shields:this.shields,exitPosition:this.mazeData.exitPosition}))}generateShieldItem(){const e=[this.playerController.getPosition(),this.mazeData.exitPosition,...this.mazeData.obstacles,...this.mazeData.traps,...this.enemyManager.getEnemies().map(i=>({x:i.x,y:i.y})),...this.saves],t=this.mazeGenerator.generateSaveItem(e);t&&this.shields.length===0&&(this.shields.push(t),this.gridRenderer.drawEntities({coins:this.mazeData.coins,obstacles:this.mazeData.obstacles,traps:this.mazeData.traps,saves:this.saves,shields:this.shields,exitPosition:this.mazeData.exitPosition}))}handleDeath(){const e=this.time.now;if(!(e<this.invincibilityEndTime)){if(this.gameState.useShield()){this.playerController.flashInvincibility(),this.updatePowerUpsUI(),this.invincibilityEndTime=e+a.POWERUPS.SHIELD_INVINCIBILITY_MS;return}this.gameState.isGameOver=!0,this.playerController.stopMovement(),this.playerController.showDeathSprite(),this.gameState.showGameOver()}}handleLevelComplete(){this.gameState.nextLevel(),this.uiManager.updateScoreAndLevel(this.gameState.score,this.gameState.level),this.playerController.stopMovement(),this.requireFreshPressAfterReset=!0,this.inputManager.resetDesiredDirection(),this.resetGame(!1)}resetGame(e){this.gridRenderer.clearCache(),this.enemyManager.reset(),this.spiderManager.reset();const t=this.mazeGenerator.generateRandomExit();this.mazeData=this.mazeGenerator.generate(t),this.saves=[],this.shields=[],this.shieldSpawned=!1,this.continueSpawned=!1,this.collision.build(this.mazeData.obstacles),this.gameState.initialCoinCount=this.mazeData.coins.length,this.gridRenderer.createGrid(this.gameState.level),this.gridRenderer.drawEntities({coins:this.mazeData.coins,obstacles:this.mazeData.obstacles,traps:this.mazeData.traps,saves:this.saves,shields:this.shields,exitPosition:this.mazeData.exitPosition}),this.playerController.reset(this.playerStartPosition);const i=[this.playerStartPosition,this.mazeData.exitPosition,...this.mazeData.obstacles,...this.mazeData.traps];this.enemyManager.init(this.gameState.level,i),this.spiderManager.generate(this.gameState.level,this.mazeData.obstacles,this.mazeData.exitPosition),this.gameState.hideGameOverUI()}handleContinueButton(){this.gameState.isGameOver&&this.gameState.useContinue()&&(this.gameState.isGameOver=!1,this.updatePowerUpsUI(),this.resetGame(!1))}handleRestartButton(){this.gameState.reset(!0),this.updatePowerUpsUI(),this.uiManager.updateScoreAndLevel(this.gameState.score,this.gameState.level),this.resetGame(!0)}updatePowerUpsUI(){this.uiManager.updatePowerUps(this.gameState.shieldCount,this.gameState.continueCount)}returnToMenu(){this.audioManager.stop(),this.gameState.returnToMenu()}shutdown(){var e,t,i,s,n,r,o,l;(e=this.inputManager)==null||e.destroy(),(t=this.audioManager)==null||t.destroy(),(i=this.playerController)==null||i.destroy(),(s=this.enemyManager)==null||s.destroy(),(n=this.spiderManager)==null||n.destroy(),(r=this.uiManager)==null||r.destroy(),(o=this.gameState)==null||o.destroy(),(l=this.gridRenderer)==null||l.destroy(),this.events.off("input:direction"),this.events.off("player:died"),this.events.off("player:reachedExit"),this.events.off("enemy:moved")}}const F={type:S.AUTO,width:a.GAME_WIDTH,height:a.GAME_HEIGHT,backgroundColor:a.UI.MAIN_BACKGROUND_COLOR,parent:"game-container",pixelArt:!0,scale:{mode:S.Scale.FIT,autoCenter:S.Scale.CENTER_BOTH},scene:[I,G]};new S.Game(F);
//# sourceMappingURL=index-CBQQ8rK6.js.map
