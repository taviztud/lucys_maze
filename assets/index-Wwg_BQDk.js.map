{"version":3,"file":"index-Wwg_BQDk.js","sources":["../../src/Config.ts","../../src/managers/ScoreManager.ts","../../src/scenes/MenuScene.ts","../../src/utils/Utils.ts","../../src/scenes/GameScene.ts","../../src/main.ts"],"sourcesContent":["import type { GameConfig } from './types/game.types';\r\n\r\nexport const CONFIG: GameConfig = {\r\n    // Configuración del juego\r\n    GAME_WIDTH: 600,\r\n    GAME_HEIGHT: 600,\r\n    BOARD_SIZE: 10,\r\n    CELL_SIZE: 60,\r\n\r\n    // Configuraciones de gameplay\r\n    MAZE_GENERATION: {\r\n        OBSTACLE_PROBABILITY: 0.2,\r\n        COIN_PROBABILITY: 0.1,\r\n        TRAP_PROBABILITY: 0.05,\r\n        MAX_ATTEMPTS: 100,\r\n        MIN_FREE_SPACES: 4\r\n    },\r\n\r\n    // Configuración de música y audio\r\n    AUDIO: {\r\n        DEFAULT_VOLUME: 0.5,\r\n        MAX_BG_TRACKS: 14\r\n    },\r\n\r\n    // UI y efectos visuales\r\n    UI: {\r\n        GAME_OVER_FONT_SIZE: '48px',\r\n        RESTART_FONT_SIZE: '24px',\r\n        RESTART_OFFSET_Y: 80,\r\n        EXIT_BLINK_ALPHA_HIGH: 1,\r\n        EXIT_BLINK_ALPHA_LOW: 0.3,\r\n        EXIT_BLINK_INTERVAL: 200,\r\n        FONT_FAMILY: '\"Press Start 2P\", cursive',\r\n        MAIN_BACKGROUND_COLOR: '#1e1e2e'\r\n    },\r\n\r\n    // Colores de NEÓN por nivel\r\n    BACKGROUND_COLORS: [0x4CC9F0, 0xF72585, 0x4AD66D, 0xF4D35E, 0x7209B7],\r\n    GRID_ALPHA: 0.15,\r\n\r\n    // Configuración de enemigos\r\n    ENEMIES: {\r\n        MIN_LEVEL_FOR_TWO: 10,\r\n        SINGLE_COUNT: 1,\r\n        DOUBLE_COUNT: 2,\r\n        MOVE_TWEEN_DURATION_MS: 1000\r\n    },\r\n\r\n    PERFORMANCE: {\r\n        INPUT_THROTTLE_MS: 16,\r\n        ENEMY_UPDATE_THROTTLE_MS: 16,\r\n        PLAYER_MIN_STEP_DURATION_MS: 200,\r\n        PLAYER_BASE_DURATION_MS: 400,\r\n        PLAYER_STEP_DEC_PER_LEVEL: 20\r\n    },\r\n\r\n    DEBUG: false\r\n};\r\n","const HIGH_SCORE_KEY = 'lucys_maze_high_score';\r\n\r\nexport class ScoreManager {\r\n    /**\r\n     * Get the current high score from localStorage\r\n     */\r\n    static getHighScore(): number {\r\n        try {\r\n            const stored = localStorage.getItem(HIGH_SCORE_KEY);\r\n            return stored ? parseInt(stored, 10) : 0;\r\n        } catch {\r\n            return 0;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Save a new high score if it beats the current record\r\n     */\r\n    static setHighScore(score: number): boolean {\r\n        try {\r\n            const current = this.getHighScore();\r\n            if (score > current) {\r\n                localStorage.setItem(HIGH_SCORE_KEY, score.toString());\r\n                return true;\r\n            }\r\n            return false;\r\n        } catch {\r\n            return false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Check if a score is a new high score\r\n     */\r\n    static isNewHighScore(score: number): boolean {\r\n        return score > this.getHighScore();\r\n    }\r\n\r\n    /**\r\n     * Reset the high score (for testing)\r\n     */\r\n    static reset(): void {\r\n        try {\r\n            localStorage.removeItem(HIGH_SCORE_KEY);\r\n        } catch {\r\n            // Ignore errors\r\n        }\r\n    }\r\n}\r\n","import Phaser from 'phaser';\r\nimport { CONFIG } from '../Config';\r\nimport { ScoreManager } from '../managers/ScoreManager';\r\n\r\nexport class MenuScene extends Phaser.Scene {\r\n    constructor() {\r\n        super('MenuScene');\r\n    }\r\n\r\n    preload() {\r\n        // Load player image for logo\r\n        this.load.image('player_stand', 'lucy_stand.png');\r\n    }\r\n\r\n    create() {\r\n        const centerX = CONFIG.GAME_WIDTH / 2;\r\n        const centerY = CONFIG.GAME_HEIGHT / 2;\r\n\r\n        // Background\r\n        this.cameras.main.setBackgroundColor(CONFIG.UI.MAIN_BACKGROUND_COLOR);\r\n\r\n        // Title - neon theme colors matching the game\r\n        const title = this.add.text(centerX, centerY - 180, \"LUCY'S MAZE\", {\r\n            fontSize: '32px',\r\n            fontFamily: CONFIG.UI.FONT_FAMILY,\r\n            color: '#F72585',\r\n            stroke: '#ff6600',\r\n            strokeThickness: 3\r\n        });\r\n        title.setOrigin(0.5);\r\n\r\n        // Subtitle with neon cyan\r\n        const subtitle = this.add.text(centerX, centerY - 130, '¡Ayuda a Lucy a encontrar la salida!', {\r\n            fontSize: '14px',\r\n            fontFamily: CONFIG.UI.FONT_FAMILY,\r\n            color: '#4CC9F0'\r\n        });\r\n        subtitle.setOrigin(0.5);\r\n\r\n        // Player sprite as logo\r\n        const playerLogo = this.add.sprite(centerX, centerY + 60, 'player_stand');\r\n        playerLogo.setScale(3);\r\n        playerLogo.setOrigin(0.5, 1);  // Origin at feet so animation scales from bottom\r\n\r\n        // Subtle breathing/idle animation - feet stay grounded\r\n        this.tweens.add({\r\n            targets: playerLogo,\r\n            scaleY: 3.08,         // Slight vertical stretch (breathing in)\r\n            scaleX: 2.95,         // Slight horizontal compress\r\n            duration: 1200,\r\n            yoyo: true,\r\n            repeat: -1,\r\n            ease: 'Sine.InOut'\r\n        });\r\n\r\n        // Play button\r\n        const playButton = this.add.text(centerX, centerY + 80, '▶ JUGAR', {\r\n            fontSize: '24px',\r\n            fontFamily: CONFIG.UI.FONT_FAMILY,\r\n            color: '#00ff00',\r\n            backgroundColor: '#003300',\r\n            padding: { x: 30, y: 15 }\r\n        });\r\n        playButton.setOrigin(0.5);\r\n        playButton.setInteractive({ useHandCursor: true });\r\n\r\n        // Hover effects\r\n        playButton.on('pointerover', () => {\r\n            playButton.setStyle({ color: '#ffffff', backgroundColor: '#006600' });\r\n            playButton.setScale(1.1);\r\n        });\r\n        playButton.on('pointerout', () => {\r\n            playButton.setStyle({ color: '#00ff00', backgroundColor: '#003300' });\r\n            playButton.setScale(1);\r\n        });\r\n        playButton.on('pointerdown', () => {\r\n            this.startGame();\r\n        });\r\n\r\n        // High score display\r\n        const highScore = ScoreManager.getHighScore();\r\n        const highScoreText = this.add.text(centerX, centerY + 160, `RÉCORD: ${highScore}`, {\r\n            fontSize: '16px',\r\n            fontFamily: CONFIG.UI.FONT_FAMILY,\r\n            color: '#ff00ff'\r\n        });\r\n        highScoreText.setOrigin(0.5);\r\n\r\n        // Instructions\r\n        const instructions = this.add.text(centerX, centerY + 220, 'Usa las flechas ← ↑ → ↓ o desliza', {\r\n            fontSize: '12px',\r\n            fontFamily: CONFIG.UI.FONT_FAMILY,\r\n            color: '#888888'\r\n        });\r\n        instructions.setOrigin(0.5);\r\n\r\n        // Allow starting with Enter or Space\r\n        this.input.keyboard.on('keydown-ENTER', () => this.startGame());\r\n        this.input.keyboard.on('keydown-SPACE', () => this.startGame());\r\n\r\n        // Touch to start\r\n        this.input.on('pointerdown', (pointer) => {\r\n            // Only start if not clicking the button\r\n            if (pointer.y < centerY + 50 || pointer.y > centerY + 120) {\r\n                // Do nothing, let button handle it\r\n            }\r\n        });\r\n    }\r\n\r\n    startGame() {\r\n        this.cameras.main.fadeOut(300, 0, 0, 0);\r\n        this.time.delayedCall(300, () => {\r\n            this.scene.start('GameScene');\r\n        });\r\n    }\r\n}\r\n","import Phaser from 'phaser';\r\nimport type { Position } from '../types/game.types';\r\n\r\n/**\r\n * Calcula la escala óptima para un sprite basado en el tamaño de celda\r\n * @param textureKey - Clave de la textura en Phaser\r\n * @param targetSize - Tamaño objetivo (generalmente cellSize)\r\n * @param scene - Escena de Phaser para acceder a texturas\r\n * @returns Factor de escala calculado\r\n */\r\nexport function calculateSpriteScale(\r\n    textureKey: string,\r\n    targetSize: number,\r\n    scene: Phaser.Scene\r\n): number {\r\n    try {\r\n        if (!scene || !scene.textures || !scene.textures.get(textureKey)) {\r\n            console.warn(`calculateSpriteScale: Invalid texture key \"${textureKey}\"`);\r\n            return 1;\r\n        }\r\n\r\n        const texture = scene.textures.get(textureKey);\r\n        const sourceImage = texture.getSourceImage() as HTMLImageElement;\r\n        const originalWidth = sourceImage.width;\r\n        const originalHeight = sourceImage.height;\r\n\r\n        return Math.min(targetSize / originalWidth, targetSize / originalHeight);\r\n    } catch (error) {\r\n        console.error('Error calculating sprite scale:', error);\r\n        return 1;\r\n    }\r\n}\r\n\r\n/**\r\n * Valida que las coordenadas estén dentro de los límites del tablero\r\n * @param x - Coordenada X\r\n * @param y - Coordenada Y\r\n * @param boardSize - Tamaño del tablero\r\n * @returns True si las coordenadas son válidas\r\n */\r\nexport function isValidPosition(x: number, y: number, boardSize: number): boolean {\r\n    return x >= 0 && x < boardSize && y >= 0 && y < boardSize;\r\n}\r\n\r\n/**\r\n * Genera una posición aleatoria libre en el tablero\r\n * @param excludePositions - Array de posiciones a excluir\r\n * @param boardSize - Tamaño del tablero\r\n * @returns Posición libre o null si no se encuentra\r\n */\r\nexport function generateFreePosition(\r\n    excludePositions: Position[] = [],\r\n    boardSize: number\r\n): Position | null {\r\n    if (!Array.isArray(excludePositions)) {\r\n        console.warn('generateFreePosition: excludePositions must be an array');\r\n        excludePositions = [];\r\n    }\r\n\r\n    if (!boardSize || boardSize < 1) {\r\n        console.error('generateFreePosition: Invalid boardSize:', boardSize);\r\n        return null;\r\n    }\r\n\r\n    const maxAttempts = 50;\r\n    let attempts = 0;\r\n\r\n    while (attempts < maxAttempts) {\r\n        const position: Position = {\r\n            x: Math.floor(Math.random() * boardSize),\r\n            y: Math.floor(Math.random() * boardSize)\r\n        };\r\n\r\n        const isOccupied = excludePositions.some(\r\n            pos => pos.x === position.x && pos.y === position.y\r\n        );\r\n\r\n        if (!isOccupied) {\r\n            return position;\r\n        }\r\n\r\n        attempts++;\r\n    }\r\n\r\n    console.warn('generateFreePosition: Could not find free position after', maxAttempts, 'attempts');\r\n    return null;\r\n}\r\n","import Phaser from 'phaser';\r\nimport { CONFIG } from '../Config';\r\nimport { calculateSpriteScale, generateFreePosition } from '../utils/Utils';\r\nimport { ScoreManager } from '../managers/ScoreManager';\r\nimport type { Position, Direction, Obstacle, Enemy, SpriteCache, EventListenerEntry, MoveResult, FinalDestination, GridSprite } from '../types/game.types';\r\n\r\nexport class GameScene extends Phaser.Scene {\r\n    // State variables\r\n    private boardSize: number;\r\n    private cellSize: number;\r\n    private playerPosition: Position;\r\n    private exitPosition: Position;\r\n    private coins: Position[];\r\n    private obstacles: Obstacle[];\r\n    private traps: Position[];\r\n    private saves: Position[];\r\n    private enemies: Enemy[];\r\n    private score: number;\r\n    private level: number;\r\n    private gameOver: boolean;\r\n    private moving: boolean;\r\n    private moveDirection: Direction;\r\n    private desiredDirection: Direction;\r\n    private playerMoveTween: Phaser.Tweens.Tween | null;\r\n    private exitBlinkState: boolean;\r\n    private requireFreshPressAfterReset: boolean;\r\n    private initialCoinCount: number;\r\n\r\n    // Audio state\r\n    private availableMusicKeys: string[];\r\n    private backgroundMusic: Phaser.Sound.BaseSound | null;\r\n    private musicPlaylistOrder: string[];\r\n    private currentPlaylistIndex: number;\r\n\r\n    // Optimization\r\n    private collisionMap: any;\r\n    private lastEnemyUpdateTime: number;\r\n    private canUseSave: boolean;\r\n    private spriteCache: SpriteCache;\r\n    private eventListenerCleanup: EventListenerEntry[];\r\n\r\n    // Juice\r\n    private coinParticles: Phaser.GameObjects.Particles.ParticleEmitter | null;\r\n    private trailParticles: Phaser.GameObjects.Particles.ParticleEmitter | null;\r\n\r\n    // Game Objects\r\n    private player: Phaser.GameObjects.Sprite;\r\n    private exit: Phaser.GameObjects.Sprite;\r\n    private scoreText: Phaser.GameObjects.Text;\r\n    private levelText: Phaser.GameObjects.Text;\r\n    private newRecordText: Phaser.GameObjects.Text;\r\n    private menuText: Phaser.GameObjects.Text;\r\n    private cursors: Phaser.Types.Input.Keyboard.CursorKeys;\r\n    private restartKey: Phaser.Input.Keyboard.Key;\r\n    private menuKey: Phaser.Input.Keyboard.Key;\r\n    private exitBlinkTimer: Phaser.Time.TimerEvent;\r\n\r\n    // Visuals\r\n    private gridGroup: Phaser.GameObjects.Group;\r\n    private coinSprites: GridSprite[];\r\n    private obstacleSprites: Phaser.GameObjects.Sprite[];\r\n    private trapSprites: Phaser.GameObjects.Sprite[];\r\n    private playerSprite: Phaser.GameObjects.Sprite;\r\n    private exitSprite: Phaser.GameObjects.Sprite;\r\n    private saveSprite: Phaser.GameObjects.Sprite;\r\n    private playerDieSprite: Phaser.GameObjects.Sprite;\r\n    private savePulseTween: Phaser.Tweens.Tween;\r\n    private exitPulseTween: Phaser.Tweens.Tween;\r\n    private gameOverText: Phaser.GameObjects.Text;\r\n    private restartText: Phaser.GameObjects.Text;\r\n\r\n    constructor() {\r\n        super('GameScene');\r\n        this.boardSize = CONFIG.BOARD_SIZE;\r\n        this.cellSize = CONFIG.CELL_SIZE;\r\n        this.playerPosition = { x: 0, y: 0 };\r\n        this.exitPosition = { x: CONFIG.BOARD_SIZE - 1, y: CONFIG.BOARD_SIZE - 1 };\r\n        this.coins = [];\r\n        this.obstacles = [];\r\n        this.traps = [];\r\n        this.saves = [];\r\n        this.enemies = [];\r\n        this.score = 0;\r\n        this.level = 1;\r\n        this.gameOver = false;\r\n        this.moving = false;\r\n        this.moveDirection = { dx: 0, dy: 0 };\r\n        this.desiredDirection = { dx: 0, dy: 0 };\r\n        this.playerMoveTween = null;\r\n        this.exitBlinkState = true;\r\n        this.requireFreshPressAfterReset = false;\r\n        this.initialCoinCount = 0;\r\n\r\n        // Audio state\r\n        this.availableMusicKeys = [];\r\n        this.backgroundMusic = null;\r\n        this.musicPlaylistOrder = [];\r\n        this.currentPlaylistIndex = 0;\r\n\r\n        // Optimization\r\n        this.collisionMap = null;\r\n        this.lastEnemyUpdateTime = 0;\r\n        this.canUseSave = false;\r\n        this.spriteCache = {\r\n            coins: [],\r\n            obstacles: [],\r\n            traps: []\r\n        };\r\n        this.eventListenerCleanup = [];\r\n\r\n        // Juice\r\n        this.coinParticles = null;\r\n        this.trailParticles = null;\r\n    }\r\n\r\n    preload() {\r\n        try {\r\n            // Error handling\r\n            this.load.on('loaderror', (file) => {\r\n                console.warn('Asset not found:', file.key, file.src);\r\n                if (file.key.startsWith('backgroundMusic')) {\r\n                    const keyIndex = this.availableMusicKeys.indexOf(file.key);\r\n                    if (keyIndex > -1) {\r\n                        this.availableMusicKeys.splice(keyIndex, 1);\r\n                    }\r\n                }\r\n            });\r\n\r\n            this.load.on('filecomplete', (key) => {\r\n                if (key.startsWith('backgroundMusic')) {\r\n                    if (!this.availableMusicKeys.includes(key)) {\r\n                        this.availableMusicKeys.push(key);\r\n                    }\r\n                }\r\n            });\r\n\r\n            // Load images\r\n            this.load.image('player_stand', 'lucy_stand.png');\r\n            // ... (rest of images)\r\n            this.load.image('player_run', 'lucy_run.png');\r\n            this.load.image('player_die', 'lucy_die.png');\r\n            this.load.image('coin', 'tuto.png');\r\n            this.load.image('obstacle_brick', 'brick_1.png');\r\n            this.load.image('obstacle_rock', 'rock_1.png');\r\n            this.load.image('obstacle_tree', 'tree_1.png');\r\n            this.load.image('trap', 'sping.png');\r\n            this.load.image('exit', 'exit.png');\r\n            this.load.image('enemy', 'enemy.png');\r\n            this.load.image('save', 'save.png');\r\n\r\n            // Detect and load music\r\n            this.detectAndLoadMusic();\r\n\r\n        } catch (error) {\r\n            console.error('Critical error in preload:', error);\r\n        }\r\n    }\r\n\r\n    detectAndLoadMusic() {\r\n        this.availableMusicKeys = [];\r\n        const maxTracks = CONFIG.AUDIO.MAX_BG_TRACKS;\r\n        for (let i = 1; i <= maxTracks; i++) {\r\n            const paddedNumber = i.toString().padStart(3, '0');\r\n            const filename = `bg_${paddedNumber}.mp3`;\r\n            const key = `backgroundMusic${i - 1}`;\r\n\r\n            try {\r\n                this.load.audio(key, `sound/bg/${filename}`);\r\n            } catch (error) {\r\n                console.warn('Could not queue music file:', filename, error);\r\n            }\r\n        }\r\n    }\r\n\r\n    create() {\r\n        // Music handling\r\n        const tryStartMusic = () => {\r\n            if (this.availableMusicKeys.length > 0) {\r\n                this.shuffleMusicPlaylist();\r\n                this.playRandomMusic();\r\n            } else {\r\n                this.time.delayedCall(500, () => {\r\n                    if (this.availableMusicKeys.length > 0) {\r\n                        this.shuffleMusicPlaylist();\r\n                        this.playRandomMusic();\r\n                    }\r\n                });\r\n            }\r\n        };\r\n\r\n        if (this.sound.locked) {\r\n            this.input.once('pointerdown', () => this.sound.unlock());\r\n            if (this.input.keyboard) this.input.keyboard.once('keydown', () => this.sound.unlock());\r\n            this.sound.once('unlocked', tryStartMusic);\r\n        } else {\r\n            this.time.delayedCall(200, tryStartMusic);\r\n        }\r\n\r\n        // Create grid\r\n        this.createGrid();\r\n\r\n        // Game Over Text\r\n        this.gameOverText = this.add.text(CONFIG.GAME_WIDTH / 2, CONFIG.GAME_HEIGHT / 2, 'GAME OVER', {\r\n            fontSize: CONFIG.UI.GAME_OVER_FONT_SIZE,\r\n            fontFamily: CONFIG.UI.FONT_FAMILY,\r\n            color: '#ff0000',\r\n            stroke: '#ffffff',\r\n            strokeThickness: 4\r\n        });\r\n        this.gameOverText.setOrigin(0.5);\r\n        this.gameOverText.setDepth(100);\r\n        this.gameOverText.setVisible(false);\r\n\r\n        // Restart Text\r\n        this.restartText = this.add.text(CONFIG.GAME_WIDTH / 2, CONFIG.GAME_HEIGHT / 2 + CONFIG.UI.RESTART_OFFSET_Y, 'PRESS R TO RESTART', {\r\n            fontSize: CONFIG.UI.RESTART_FONT_SIZE,\r\n            fontFamily: CONFIG.UI.FONT_FAMILY,\r\n            color: '#ffff00',\r\n            align: 'center'\r\n        });\r\n        this.restartText.setOrigin(0.5);\r\n        this.restartText.setDepth(100);\r\n        this.restartText.setVisible(false);\r\n\r\n        // Initialize maze\r\n        this.generateRandomExit();\r\n        this.generateMaze();\r\n        this.initialCoinCount = this.coins.length;\r\n        this.buildCollisionMap();\r\n\r\n        // Draw game\r\n        this.drawGame();\r\n\r\n        // Controls\r\n        this.cursors = this.input.keyboard.createCursorKeys();\r\n        this.restartKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.R);\r\n        this.menuKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.M);\r\n\r\n        // Exit animation - smooth pulsing instead of simple blink\r\n        this.startExitAnimation();\r\n\r\n        // UI Event Listeners\r\n        this.setupUIEventListeners();\r\n\r\n        // Keyboard Input\r\n        this.input.keyboard.on('keydown', (event) => {\r\n            switch (event.code) {\r\n                case 'ArrowLeft':\r\n                    this.desiredDirection = { dx: -1, dy: 0 };\r\n                    break;\r\n                case 'ArrowRight':\r\n                    this.desiredDirection = { dx: 1, dy: 0 };\r\n                    break;\r\n                case 'ArrowUp':\r\n                    this.desiredDirection = { dx: 0, dy: -1 };\r\n                    break;\r\n                case 'ArrowDown':\r\n                    this.desiredDirection = { dx: 0, dy: 1 };\r\n                    break;\r\n                default:\r\n                    break;\r\n            }\r\n\r\n            if (!this.moving && (this.desiredDirection.dx !== 0 || this.desiredDirection.dy !== 0) && !this.gameOver) {\r\n                this.movePlayer(this.desiredDirection.dx, this.desiredDirection.dy);\r\n                this.requireFreshPressAfterReset = false;\r\n            }\r\n        });\r\n\r\n        // Touch/Swipe controls for mobile\r\n        this.setupTouchControls();\r\n\r\n        this.updateScoreAndLevelTexts();\r\n\r\n        if (this.level >= 5) {\r\n            this.initEnemies();\r\n        }\r\n\r\n        // Juice\r\n        this.coinParticles = this.add.particles(0, 0, 'coin', {\r\n            speed: { min: 50, max: 150 },\r\n            scale: { start: 0.4, end: 0 },\r\n            lifespan: 600,\r\n            blendMode: 'ADD',\r\n            quantity: 10,\r\n            emitting: false\r\n        });\r\n\r\n        this.trailParticles = this.add.particles(0, 0, 'player_run', {\r\n            speed: 0,\r\n            scale: { start: calculateSpriteScale('player_run', this.cellSize, this) * 0.9, end: 0.7 },\r\n            alpha: { start: 0.15, end: 0 },\r\n            lifespan: 1000,\r\n            blendMode: 'ADD',\r\n            frequency: 140,\r\n            emitting: false\r\n        });\r\n    }\r\n\r\n    update(time, delta) {\r\n        if (this.gameOver) {\r\n            if (Phaser.Input.Keyboard.JustDown(this.restartKey)) {\r\n                this.score = 0;\r\n                this.level = 1;\r\n                this.updateScoreAndLevelTexts();\r\n                this.resetGame(true);\r\n            }\r\n            if (Phaser.Input.Keyboard.JustDown(this.menuKey)) {\r\n                this.returnToMenu();\r\n            }\r\n            return;\r\n        }\r\n\r\n        // Enemy updates\r\n        if (time > this.lastEnemyUpdateTime + CONFIG.PERFORMANCE.ENEMY_UPDATE_THROTTLE_MS) {\r\n            this.updateEnemies();\r\n            this.lastEnemyUpdateTime = time;\r\n        }\r\n    }\r\n\r\n    createGrid() {\r\n        // Background color\r\n        this.cameras.main.setBackgroundColor(CONFIG.UI.MAIN_BACKGROUND_COLOR);\r\n\r\n        // Neon color based on level\r\n        const neonColor = CONFIG.BACKGROUND_COLORS[(this.level - 1) % CONFIG.BACKGROUND_COLORS.length];\r\n\r\n        // Create grid group\r\n        if (this.gridGroup && this.gridGroup.children) {\r\n            this.gridGroup.clear(true, true);\r\n        } else {\r\n            this.gridGroup = this.add.group();\r\n        }\r\n\r\n        // Draw grid\r\n        const graphics = this.add.graphics();\r\n        graphics.lineStyle(1, neonColor, CONFIG.GRID_ALPHA);\r\n\r\n        for (let i = 0; i <= this.boardSize; i++) {\r\n            // Vertical lines\r\n            graphics.moveTo(i * this.cellSize, 0);\r\n            graphics.lineTo(i * this.cellSize, this.boardSize * this.cellSize);\r\n\r\n            // Horizontal lines\r\n            graphics.moveTo(0, i * this.cellSize);\r\n            graphics.lineTo(this.boardSize * this.cellSize, i * this.cellSize);\r\n        }\r\n\r\n        graphics.strokePath();\r\n        this.gridGroup.add(graphics);\r\n\r\n        // Add dots at intersections\r\n        for (let y = 0; y < this.boardSize; y++) {\r\n            for (let x = 0; x < this.boardSize; x++) {\r\n                const dot = this.add.rectangle(\r\n                    x * this.cellSize + this.cellSize / 2,\r\n                    y * this.cellSize + this.cellSize / 2,\r\n                    2,\r\n                    2,\r\n                    neonColor\r\n                );\r\n                dot.setAlpha(0.6);\r\n                this.gridGroup.add(dot);\r\n            }\r\n        }\r\n    }\r\n\r\n    generateRandomExit() {\r\n        const side = Math.floor(Math.random() * 2);\r\n        if (side === 0) {\r\n            this.exitPosition = { x: this.boardSize - 1, y: Math.floor(Math.random() * this.boardSize) };\r\n        } else {\r\n            this.exitPosition = { x: Math.floor(Math.random() * this.boardSize), y: this.boardSize - 1 };\r\n        }\r\n    }\r\n\r\n    generateMaze() {\r\n        try {\r\n            if (!this.boardSize || this.boardSize < 3) {\r\n                console.error('generateMaze: Invalid boardSize:', this.boardSize);\r\n                return;\r\n            }\r\n\r\n            let attempts = 0;\r\n            const maxAttempts = CONFIG.MAZE_GENERATION.MAX_ATTEMPTS;\r\n\r\n            do {\r\n                attempts++;\r\n                this.coins.length = 0;\r\n                this.obstacles.length = 0;\r\n                this.traps.length = 0;\r\n                this.saves.length = 0;\r\n\r\n                for (let y = 0; y < this.boardSize; y++) {\r\n                    for (let x = 0; x < this.boardSize; x++) {\r\n                        if ((x !== 0 || y !== 0) && (x !== this.exitPosition.x || y !== this.exitPosition.y)) {\r\n                            if (Math.random() < CONFIG.MAZE_GENERATION.OBSTACLE_PROBABILITY && this.hasEnoughSpace(x, y)) {\r\n                                const obstacleTypes = ['brick', 'rock', 'tree'];\r\n                                const randomType = obstacleTypes[Phaser.Math.Between(0, obstacleTypes.length - 1)] as 'brick' | 'rock' | 'tree';\r\n                                this.obstacles.push({ x, y, type: randomType });\r\n                            } else if (Math.random() < CONFIG.MAZE_GENERATION.COIN_PROBABILITY) {\r\n                                this.coins.push({ x, y });\r\n                            } else if (Math.random() < CONFIG.MAZE_GENERATION.TRAP_PROBABILITY && this.hasEnoughSpace(x, y)) {\r\n                                this.traps.push({ x, y });\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            } while (!this.isSolvable() && attempts < maxAttempts);\r\n\r\n            if (attempts >= maxAttempts) {\r\n                console.warn('generateMaze: Max attempts reached, generating simple maze');\r\n                this.coins.length = 0;\r\n                this.obstacles.length = 0;\r\n                this.traps.length = 0;\r\n                this.saves.length = 0;\r\n                this.coins.push({ x: 2, y: 2 }, { x: 5, y: 5 }, { x: 7, y: 3 });\r\n                this.obstacles.push({ x: 3, y: 4, type: 'brick' }, { x: 6, y: 7, type: 'rock' });\r\n            }\r\n        } catch (error) {\r\n            console.error('Error in generateMaze:', error);\r\n            this.coins.length = 0;\r\n            this.obstacles.length = 0;\r\n            this.traps.length = 0;\r\n            this.saves.length = 0;\r\n            this.coins.push({ x: 1, y: 1 });\r\n        }\r\n    }\r\n\r\n    isSolvable() {\r\n        const queue = [{ x: this.playerPosition.x, y: this.playerPosition.y }];\r\n        const visited = Array.from({ length: this.boardSize }, () => Array(this.boardSize).fill(false));\r\n        visited[this.playerPosition.y][this.playerPosition.x] = true;\r\n\r\n        const directions = [\r\n            { x: 0, y: -1 },\r\n            { x: 1, y: 0 },\r\n            { x: 0, y: 1 },\r\n            { x: -1, y: 0 }\r\n        ];\r\n\r\n        while (queue.length > 0) {\r\n            const { x, y } = queue.shift();\r\n\r\n            if (x === this.exitPosition.x && y === this.exitPosition.y) {\r\n                return true;\r\n            }\r\n\r\n            for (let dir of directions) {\r\n                const nx = x + dir.x;\r\n                const ny = y + dir.y;\r\n\r\n                if (\r\n                    nx >= 0 && nx < this.boardSize &&\r\n                    ny >= 0 && ny < this.boardSize &&\r\n                    !visited[ny][nx] &&\r\n                    !this.obstacles.some(obstacle => obstacle.x === nx && obstacle.y === ny) &&\r\n                    !this.traps.some(trap => trap.x === nx && trap.y === ny)\r\n                ) {\r\n                    visited[ny][nx] = true;\r\n                    queue.push({ x: nx, y: ny });\r\n                }\r\n            }\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    hasEnoughSpace(x, y) {\r\n        const directions = [\r\n            { x: 0, y: -1 }, { x: 1, y: 0 }, { x: 0, y: 1 }, { x: -1, y: 0 },\r\n            { x: -1, y: -1 }, { x: 1, y: -1 }, { x: -1, y: 1 }, { x: 1, y: 1 }\r\n        ];\r\n\r\n        let freeSpaces = 0;\r\n        for (let dir of directions) {\r\n            const nx = x + dir.x;\r\n            const ny = y + dir.y;\r\n            if (\r\n                nx >= 0 && nx < this.boardSize &&\r\n                ny >= 0 && ny < this.boardSize &&\r\n                !this.obstacles.some(obs => obs.x === nx && obs.y === ny) &&\r\n                !this.traps.some(trap => trap.x === nx && trap.y === ny)\r\n            ) {\r\n                freeSpaces++;\r\n            }\r\n        }\r\n\r\n        return freeSpaces >= CONFIG.MAZE_GENERATION.MIN_FREE_SPACES;\r\n    }\r\n\r\n    buildCollisionMap() {\r\n        if (!this.boardSize || this.boardSize < 1) {\r\n            console.error('buildCollisionMap: Invalid boardSize:', this.boardSize);\r\n            return;\r\n        }\r\n\r\n        try {\r\n            this.collisionMap = Array.from({ length: this.boardSize }, () => Array(this.boardSize).fill(false));\r\n            this.obstacles.forEach(obstacle => {\r\n                if (obstacle.x >= 0 && obstacle.x < this.boardSize && obstacle.y >= 0 && obstacle.y < this.boardSize) {\r\n                    this.collisionMap[obstacle.y][obstacle.x] = true;\r\n                }\r\n            });\r\n        } catch (error) {\r\n            console.error('Error building collision map:', error);\r\n            this.collisionMap = Array.from({ length: this.boardSize || 10 }, () => Array(this.boardSize || 10).fill(false));\r\n        }\r\n    }\r\n\r\n    drawGame() {\r\n        // Clear existing sprites\r\n        this.clearSpriteCache();\r\n        this.coinSprites = this.coinSprites || [];\r\n        this.obstacleSprites = this.obstacleSprites || [];\r\n        this.trapSprites = this.trapSprites || [];\r\n\r\n        // Draw Player\r\n        if (!this.playerSprite) {\r\n            this.playerSprite = this.add.sprite(\r\n                this.playerPosition.x * this.cellSize + this.cellSize / 2,\r\n                this.playerPosition.y * this.cellSize + this.cellSize / 2,\r\n                'player_stand'\r\n            );\r\n        } else {\r\n            this.playerSprite.setPosition(\r\n                this.playerPosition.x * this.cellSize + this.cellSize / 2,\r\n                this.playerPosition.y * this.cellSize + this.cellSize / 2\r\n            );\r\n            this.playerSprite.setVisible(true);\r\n            this.playerSprite.setDepth(10); // Ensure player is on top\r\n        }\r\n        this.adjustPlayerScaleAndRotation();\r\n\r\n        // Draw Exit\r\n        if (!this.exitSprite) {\r\n            this.exitSprite = this.add.sprite(\r\n                this.exitPosition.x * this.cellSize + this.cellSize / 2,\r\n                this.exitPosition.y * this.cellSize + this.cellSize / 2,\r\n                'exit'\r\n            );\r\n        } else {\r\n            this.exitSprite.setPosition(\r\n                this.exitPosition.x * this.cellSize + this.cellSize / 2,\r\n                this.exitPosition.y * this.cellSize + this.cellSize / 2\r\n            );\r\n            this.exitSprite.setVisible(true);\r\n        }\r\n        const exitScale = calculateSpriteScale('exit', this.cellSize, this);\r\n        this.exitSprite.setScale(exitScale);\r\n        this.startExitAnimation();\r\n\r\n        // Draw Coins\r\n        this.coinSprites = [];\r\n        this.coins.forEach((coin, index) => {\r\n            let coinSprite;\r\n            if (this.spriteCache.coins[index] && this.spriteCache.coins[index].active) {\r\n                coinSprite = this.spriteCache.coins[index];\r\n                coinSprite.setPosition(\r\n                    coin.x * this.cellSize + this.cellSize / 2,\r\n                    coin.y * this.cellSize + this.cellSize / 2\r\n                );\r\n                coinSprite.setVisible(true);\r\n            } else {\r\n                coinSprite = this.add.sprite(\r\n                    coin.x * this.cellSize + this.cellSize / 2,\r\n                    coin.y * this.cellSize + this.cellSize / 2,\r\n                    'coin'\r\n                );\r\n                const coinScale = calculateSpriteScale('coin', this.cellSize, this);\r\n                coinSprite.setScale(coinScale);\r\n                this.spriteCache.coins[index] = coinSprite;\r\n            }\r\n            // Store grid position for easy removal\r\n            (coinSprite as GridSprite).gridX = coin.x;\r\n            (coinSprite as GridSprite).gridY = coin.y;\r\n            this.coinSprites.push(coinSprite as GridSprite);\r\n        });\r\n\r\n        // Draw Obstacles\r\n        this.obstacleSprites = [];\r\n        this.obstacles.forEach((obstacle, index) => {\r\n            let obstacleSprite;\r\n            if (this.spriteCache.obstacles[index] && this.spriteCache.obstacles[index].active) {\r\n                obstacleSprite = this.spriteCache.obstacles[index];\r\n                obstacleSprite.setPosition(\r\n                    obstacle.x * this.cellSize + this.cellSize / 2,\r\n                    obstacle.y * this.cellSize + this.cellSize / 2\r\n                );\r\n                obstacleSprite.setTexture(`obstacle_${obstacle.type}`);\r\n                obstacleSprite.setVisible(true);\r\n            } else {\r\n                obstacleSprite = this.add.sprite(\r\n                    obstacle.x * this.cellSize + this.cellSize / 2,\r\n                    obstacle.y * this.cellSize + this.cellSize / 2,\r\n                    `obstacle_${obstacle.type}`\r\n                );\r\n                const obstacleScale = calculateSpriteScale(`obstacle_${obstacle.type}`, this.cellSize, this);\r\n                obstacleSprite.setScale(obstacleScale);\r\n                this.spriteCache.obstacles[index] = obstacleSprite;\r\n            }\r\n            // Tag sprite with obstacle data for tree animation\r\n            (obstacleSprite as any).obstacleType = obstacle.type;\r\n            (obstacleSprite as any).gridX = obstacle.x;\r\n            (obstacleSprite as any).gridY = obstacle.y;\r\n            this.obstacleSprites.push(obstacleSprite);\r\n        });\r\n\r\n        // Draw Traps\r\n        this.trapSprites = [];\r\n        this.traps.forEach((trap, index) => {\r\n            let trapSprite;\r\n            if (this.spriteCache.traps[index] && this.spriteCache.traps[index].active) {\r\n                trapSprite = this.spriteCache.traps[index];\r\n                trapSprite.setPosition(\r\n                    trap.x * this.cellSize + this.cellSize / 2,\r\n                    trap.y * this.cellSize + this.cellSize / 2\r\n                );\r\n                trapSprite.setVisible(true);\r\n            } else {\r\n                trapSprite = this.add.sprite(\r\n                    trap.x * this.cellSize + this.cellSize / 2,\r\n                    trap.y * this.cellSize + this.cellSize / 2,\r\n                    'trap'\r\n                );\r\n                const trapScale = calculateSpriteScale('trap', this.cellSize, this);\r\n                trapSprite.setScale(trapScale);\r\n                this.spriteCache.traps[index] = trapSprite;\r\n            }\r\n\r\n            // Spinning animation with acceleration (slow start, speed up)\r\n            // Staggered delays so traps don't all spin at the same time\r\n            const staggerDelay = Phaser.Math.Between(0, 2000);\r\n            this.time.delayedCall(staggerDelay, () => {\r\n                if (trapSprite && trapSprite.active) {\r\n                    this.tweens.add({\r\n                        targets: trapSprite,\r\n                        angle: 360,\r\n                        duration: 1500,\r\n                        ease: 'Cubic.InOut',  // Starts slow, accelerates, then slows\r\n                        repeat: -1,\r\n                        onRepeat: (tween) => {\r\n                            trapSprite.setAngle(0);  // Reset angle for smooth loop\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n\r\n            this.trapSprites.push(trapSprite);\r\n        });\r\n\r\n        // Draw Save\r\n        if (this.saves.length > 0) {\r\n            const save = this.saves[0];\r\n            if (!this.saveSprite) {\r\n                this.saveSprite = this.add.sprite(\r\n                    save.x * this.cellSize + this.cellSize / 2,\r\n                    save.y * this.cellSize + this.cellSize / 2,\r\n                    'save'\r\n                );\r\n            } else {\r\n                this.saveSprite.setPosition(\r\n                    save.x * this.cellSize + this.cellSize / 2,\r\n                    save.y * this.cellSize + this.cellSize / 2\r\n                );\r\n                this.saveSprite.setVisible(true);\r\n            }\r\n            const saveScale = calculateSpriteScale('save', this.cellSize, this);\r\n            this.saveSprite.setScale(saveScale);\r\n            this.saveSprite.setAlpha(1);\r\n\r\n            // Pulse tween\r\n            if (this.savePulseTween) {\r\n                this.savePulseTween.stop();\r\n            }\r\n            this.savePulseTween = this.tweens.add({\r\n                targets: this.saveSprite,\r\n                scaleX: { from: saveScale * 0.95, to: saveScale * 1.08 },\r\n                scaleY: { from: saveScale * 0.95, to: saveScale * 1.08 },\r\n                alpha: { from: 0.9, to: 1.0 },\r\n                ease: 'Sine.InOut',\r\n                duration: 600,\r\n                yoyo: true,\r\n                repeat: -1\r\n            });\r\n        } else if (this.saveSprite) {\r\n            this.saveSprite.setVisible(false);\r\n        }\r\n\r\n        // Hide unused sprites\r\n        this.hideUnusedSprites(this.coinSprites, 'coins');\r\n        this.hideUnusedSprites(this.obstacleSprites, 'obstacles');\r\n        this.hideUnusedSprites(this.trapSprites, 'traps');\r\n\r\n        // Update enemy sprites\r\n        if (this.level >= 5) {\r\n            this.enemies.forEach(enemy => {\r\n                if (enemy.sprite) {\r\n                    if (enemy.direction.dx === -1) {\r\n                        enemy.sprite.setFlipX(true);\r\n                    } else if (enemy.direction.dx === 1) {\r\n                        enemy.sprite.setFlipX(false);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    movePlayer(dx, dy) {\r\n        if (this.gameOver || this.moving) return;\r\n        if (dx === 0 && dy === 0) return;\r\n\r\n        this.moveDirection = { dx, dy };\r\n        const moveResult = this.calculateMoveUntilObstacle(this.playerPosition.x, this.playerPosition.y, dx, dy);\r\n\r\n        if (moveResult.distance === 0) {\r\n            this.resetMovementState();\r\n            return;\r\n        }\r\n\r\n        this.startMovement();\r\n        const baseStepDuration = this.calculateStepDuration();\r\n        const finalDestination = this.calculateFinalDestination(dx, dy, moveResult);\r\n\r\n        this.executeMovementTween(dx, dy, baseStepDuration, finalDestination);\r\n    }\r\n\r\n    // Helper: Reset movement state when no movement possible\r\n    resetMovementState() {\r\n        this.moveDirection = { dx: 0, dy: 0 };\r\n        if (this.playerSprite) {\r\n            this.playerSprite.setTexture('player_stand');\r\n            this.adjustPlayerScaleAndRotation();\r\n        }\r\n    }\r\n\r\n    // Helper: Initialize movement state\r\n    startMovement() {\r\n        this.moving = true;\r\n        this.playerSprite.setTexture('player_run');\r\n        this.adjustPlayerScaleAndRotation();\r\n\r\n        if (this.trailParticles) {\r\n            this.trailParticles.start();\r\n            this.trailParticles.startFollow(this.playerSprite);\r\n        }\r\n    }\r\n\r\n    // Helper: Calculate step duration based on level\r\n    calculateStepDuration() {\r\n        return Math.max(\r\n            CONFIG.PERFORMANCE.PLAYER_MIN_STEP_DURATION_MS,\r\n            CONFIG.PERFORMANCE.PLAYER_BASE_DURATION_MS - this.level * CONFIG.PERFORMANCE.PLAYER_STEP_DEC_PER_LEVEL\r\n        );\r\n    }\r\n\r\n    // Helper: Find the actual destination considering traps, enemies, exit\r\n    calculateFinalDestination(dx, dy, moveResult) {\r\n        const startX = this.playerPosition.x;\r\n        const startY = this.playerPosition.y;\r\n        const finalDestination = { x: moveResult.x, y: moveResult.y, step: moveResult.distance };\r\n\r\n        for (let i = 1; i <= moveResult.distance; i++) {\r\n            const checkX = startX + (dx * i);\r\n            const checkY = startY + (dy * i);\r\n\r\n            // Stop at trap\r\n            if (this.isTrapOptimized(checkX, checkY)) {\r\n                return { x: checkX, y: checkY, step: i };\r\n            }\r\n            // Stop at enemy\r\n            if (this.enemies.some(e => Math.round(e.x) === checkX && Math.round(e.y) === checkY)) {\r\n                return { x: checkX, y: checkY, step: i };\r\n            }\r\n            // Stop at exit\r\n            if (checkX === this.exitPosition.x && checkY === this.exitPosition.y) {\r\n                return { x: checkX, y: checkY, step: i };\r\n            }\r\n        }\r\n\r\n        return finalDestination;\r\n    }\r\n\r\n    // Helper: Execute the movement tween\r\n    executeMovementTween(dx, dy, baseStepDuration, finalDestination) {\r\n        const startX = this.playerPosition.x;\r\n        const startY = this.playerPosition.y;\r\n        let lastStepProcessed = -1;\r\n\r\n        this.playerMoveTween = this.tweens.add({\r\n            targets: this.playerSprite,\r\n            x: finalDestination.x * this.cellSize + this.cellSize / 2,\r\n            y: finalDestination.y * this.cellSize + this.cellSize / 2,\r\n            duration: baseStepDuration * finalDestination.step,\r\n            ease: 'Linear',\r\n            onUpdate: (tween) => {\r\n                const result = this.onMovementUpdate(tween, dx, dy, startX, startY, finalDestination, lastStepProcessed);\r\n                if (result !== null) lastStepProcessed = result;\r\n            },\r\n            onComplete: () => {\r\n                this.onMovementComplete(finalDestination);\r\n            },\r\n            callbackScope: this\r\n        });\r\n    }\r\n\r\n    // Helper: Process each step during movement\r\n    onMovementUpdate(tween, dx, dy, startX, startY, finalDestination, lastStepProcessed) {\r\n        const progress = tween.progress;\r\n        const currentStep = Math.floor(progress * finalDestination.step);\r\n        const stepStart = Math.max(0, lastStepProcessed + 1);\r\n\r\n        for (let step = stepStart; step <= currentStep; step++) {\r\n            const newLogicalX = startX + (dx * step);\r\n            const newLogicalY = startY + (dy * step);\r\n\r\n            if (newLogicalX !== this.playerPosition.x || newLogicalY !== this.playerPosition.y) {\r\n                this.playerPosition.x = newLogicalX;\r\n                this.playerPosition.y = newLogicalY;\r\n\r\n                this.processItemsAtPosition(this.playerPosition.x, this.playerPosition.y);\r\n\r\n                // Check death conditions\r\n                if (this.isTrapOptimized(this.playerPosition.x, this.playerPosition.y)) {\r\n                    this.handleDeath();\r\n                    return null;\r\n                }\r\n                if (this.enemies.some(e => Math.round(e.x) === this.playerPosition.x && Math.round(e.y) === this.playerPosition.y)) {\r\n                    this.handleDeath();\r\n                    return null;\r\n                }\r\n\r\n                // Check level complete\r\n                if (this.playerPosition.x === this.exitPosition.x && this.playerPosition.y === this.exitPosition.y) {\r\n                    this.handleLevelComplete();\r\n                    return null;\r\n                }\r\n\r\n                // Check for turn opportunity\r\n                if (this.checkTurnOpportunity(tween)) {\r\n                    return null;\r\n                }\r\n            }\r\n        }\r\n        return currentStep;\r\n    }\r\n\r\n    // Helper: Check if player can turn at current position\r\n    checkTurnOpportunity(tween) {\r\n        if ((this.desiredDirection.dx !== 0 || this.desiredDirection.dy !== 0) &&\r\n            (this.desiredDirection.dx !== this.moveDirection.dx || this.desiredDirection.dy !== this.moveDirection.dy)) {\r\n            const turnNextX = this.playerPosition.x + this.desiredDirection.dx;\r\n            const turnNextY = this.playerPosition.y + this.desiredDirection.dy;\r\n\r\n            if (!this.isCollisionOptimized(turnNextX, turnNextY)) {\r\n                this.playerSprite.setPosition(\r\n                    this.playerPosition.x * this.cellSize + this.cellSize / 2,\r\n                    this.playerPosition.y * this.cellSize + this.cellSize / 2\r\n                );\r\n                tween.stop();\r\n                this.moving = false;\r\n                this.movePlayer(this.desiredDirection.dx, this.desiredDirection.dy);\r\n                return true;\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n\r\n    // Helper: Finalize movement\r\n    onMovementComplete(finalDestination) {\r\n        if (this.trailParticles) this.trailParticles.stop();\r\n\r\n        this.playerPosition.x = finalDestination.x;\r\n        this.playerPosition.y = finalDestination.y;\r\n\r\n        if (finalDestination.step > 0 && !this.gameOver) {\r\n            this.cameras.main.shake(100, 0.005);\r\n        }\r\n\r\n        this.processItemsAtPosition(this.playerPosition.x, this.playerPosition.y);\r\n\r\n        if (this.isTrapOptimized(this.playerPosition.x, this.playerPosition.y)) {\r\n            this.handleDeath();\r\n            return;\r\n        }\r\n        if (this.playerPosition.x === this.exitPosition.x && this.playerPosition.y === this.exitPosition.y) {\r\n            this.handleLevelComplete();\r\n            return;\r\n        }\r\n\r\n        this.moving = false;\r\n        this.playerMoveTween = null;\r\n        this.moveDirection = { dx: 0, dy: 0 };\r\n        this.playerSprite.setTexture('player_stand');\r\n        this.adjustPlayerScaleAndRotation();\r\n    }\r\n\r\n    clearSpriteCache() {\r\n        Object.keys(this.spriteCache).forEach(key => {\r\n            this.spriteCache[key].forEach(sprite => {\r\n                if (sprite && sprite.destroy) {\r\n                    sprite.destroy();\r\n                }\r\n            });\r\n            this.spriteCache[key] = [];\r\n        });\r\n    }\r\n\r\n    hideUnusedSprites(usedSprites, cacheKey) {\r\n        const cache = this.spriteCache[cacheKey];\r\n        for (let i = usedSprites.length; i < cache.length; i++) {\r\n            if (cache[i]) {\r\n                cache[i].setVisible(false);\r\n            }\r\n        }\r\n    }\r\n\r\n    adjustPlayerScaleAndRotation() {\r\n        if (!this.playerSprite) return;\r\n\r\n        const playerScale = calculateSpriteScale(this.playerSprite.texture.key, this.cellSize, this);\r\n        this.playerSprite.setScale(playerScale);\r\n\r\n        if (this.moveDirection.dx === 1) {\r\n            this.playerSprite.setAngle(0);\r\n            this.playerSprite.setFlipX(false);\r\n        } else if (this.moveDirection.dx === -1) {\r\n            this.playerSprite.setAngle(0);\r\n            this.playerSprite.setFlipX(true);\r\n        } else if (this.moveDirection.dy === -1) {\r\n            this.playerSprite.setAngle(-90);\r\n            this.playerSprite.setFlipX(false);\r\n        } else if (this.moveDirection.dy === 1) {\r\n            this.playerSprite.setAngle(90);\r\n            this.playerSprite.setFlipX(false);\r\n        }\r\n    }\r\n\r\n    calculateMoveUntilObstacle(startX, startY, dx, dy) {\r\n        let currentX = startX;\r\n        let currentY = startY;\r\n        let distance = 0;\r\n\r\n        while (true) {\r\n            let nextX = currentX + dx;\r\n            let nextY = currentY + dy;\r\n\r\n            if (this.isCollisionOptimized(nextX, nextY)) {\r\n                break;\r\n            }\r\n\r\n            currentX = nextX;\r\n            currentY = nextY;\r\n            distance++;\r\n        }\r\n\r\n        return { x: currentX, y: currentY, distance };\r\n    }\r\n\r\n    processItemsAtPosition(x, y) {\r\n        // Coins\r\n        for (let i = this.coins.length - 1; i >= 0; i--) {\r\n            if (this.coins[i].x === x && this.coins[i].y === y) {\r\n                // Particles\r\n                if (this.coinParticles) {\r\n                    this.coinParticles.emitParticleAt(\r\n                        x * this.cellSize + this.cellSize / 2,\r\n                        y * this.cellSize + this.cellSize / 2\r\n                    );\r\n                }\r\n\r\n                this.coins.splice(i, 1);\r\n                this.score += 10;\r\n                this.updateScoreAndLevelTexts();\r\n\r\n                // Remove sprite\r\n                for (let j = this.coinSprites.length - 1; j >= 0; j--) {\r\n                    if (this.coinSprites[j].gridX === x && this.coinSprites[j].gridY === y) {\r\n                        this.coinSprites[j].destroy();\r\n                        this.coinSprites.splice(j, 1);\r\n                        break;\r\n                    }\r\n                }\r\n\r\n                // Generate save item\r\n                if (this.initialCoinCount > 0) {\r\n                    const collected = this.initialCoinCount - this.coins.length;\r\n                    const ratio = collected / this.initialCoinCount;\r\n                    if (ratio > 0.7 && this.saves.length === 0) {\r\n                        this.generateSaveItem();\r\n                        this.drawGame();\r\n                    }\r\n                }\r\n                break;\r\n            }\r\n        }\r\n\r\n        // Saves\r\n        if (this.saves.length > 0) {\r\n            const save = this.saves[0];\r\n            if (save.x === x && save.y === y) {\r\n                this.canUseSave = true;\r\n                this.saves.splice(0, 1);\r\n                if (this.saveSprite) {\r\n                    if (this.savePulseTween) {\r\n                        this.savePulseTween.stop();\r\n                        this.savePulseTween = null;\r\n                    }\r\n                    this.saveSprite.destroy();\r\n                    this.saveSprite = null;\r\n                }\r\n            }\r\n        }\r\n\r\n        // Animate nearby trees when Lucy passes\r\n        this.animateNearbyTrees(x, y);\r\n    }\r\n\r\n    animateNearbyTrees(playerX: number, playerY: number) {\r\n        this.obstacles.forEach((obstacle, index) => {\r\n            if (obstacle.type !== 'tree') return;\r\n\r\n            // Check if tree is adjacent (within 1 cell)\r\n            const distX = Math.abs(obstacle.x - playerX);\r\n            const distY = Math.abs(obstacle.y - playerY);\r\n            if (distX <= 1 && distY <= 1 && (distX + distY) > 0) {\r\n                const treeSprite = this.spriteCache.obstacles[index];\r\n                if (treeSprite && treeSprite.active) {\r\n                    // Subtle sway animation - only if not already animating\r\n                    if (!(treeSprite as any).isSwaying) {\r\n                        (treeSprite as any).isSwaying = true;\r\n                        const swayDirection = playerX < obstacle.x ? -1 : 1;\r\n                        this.tweens.add({\r\n                            targets: treeSprite,\r\n                            angle: { from: 0, to: swayDirection * 8 },\r\n                            duration: 150,\r\n                            ease: 'Sine.InOut',\r\n                            yoyo: true,\r\n                            repeat: 1,\r\n                            onComplete: () => {\r\n                                treeSprite.setAngle(0);\r\n                                (treeSprite as any).isSwaying = false;\r\n                            }\r\n                        });\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    isCollisionOptimized(x, y) {\r\n        if (x < 0 || x >= this.boardSize || y < 0 || y >= this.boardSize) {\r\n            return true;\r\n        }\r\n        return this.collisionMap && this.collisionMap[y] && this.collisionMap[y][x];\r\n    }\r\n\r\n    isTrapOptimized(x, y) {\r\n        if (x < 0 || x >= this.boardSize || y < 0 || y >= this.boardSize) {\r\n            return false;\r\n        }\r\n        return this.traps.some(trap => trap.x === x && trap.y === y);\r\n    }\r\n\r\n    handleDeath() {\r\n        this.gameOver = true;\r\n        this.moveDirection = { dx: 0, dy: 0 };\r\n        if (this.playerMoveTween) {\r\n            this.playerMoveTween.stop();\r\n            this.playerMoveTween = null;\r\n        }\r\n        this.moving = false;\r\n        this.drawGame();\r\n        this.showGameOver();\r\n\r\n        // Death sprite\r\n        if (this.playerSprite) {\r\n            this.playerSprite.destroy();\r\n            this.playerSprite = null;\r\n        }\r\n        this.playerDieSprite = this.add.sprite(\r\n            this.playerPosition.x * this.cellSize + this.cellSize / 2,\r\n            this.playerPosition.y * this.cellSize + this.cellSize / 2,\r\n            'player_die'\r\n        );\r\n        const playerDieScale = calculateSpriteScale('player_die', this.cellSize, this);\r\n        this.playerDieSprite.setScale(playerDieScale);\r\n    }\r\n\r\n    handleLevelComplete() {\r\n        this.score += 100;\r\n        this.level += 1;\r\n        this.updateScoreAndLevelTexts();\r\n        if (this.playerMoveTween) {\r\n            this.playerMoveTween.stop();\r\n            this.playerMoveTween = null;\r\n        }\r\n        this.moving = false;\r\n        this.requireFreshPressAfterReset = true;\r\n        this.desiredDirection = { dx: 0, dy: 0 };\r\n        this.resetGame(false);\r\n    }\r\n\r\n    returnToMenu() {\r\n        // Clean up\r\n        if (this.backgroundMusic) {\r\n            this.backgroundMusic.stop();\r\n        }\r\n        // Hide any new record text\r\n        if (this.newRecordText) {\r\n            this.newRecordText.setVisible(false);\r\n        }\r\n        if (this.menuText) {\r\n            this.menuText.setVisible(false);\r\n        }\r\n        // Transition to menu\r\n        this.cameras.main.fadeOut(300, 0, 0, 0);\r\n        this.time.delayedCall(300, () => {\r\n            this.scene.start('MenuScene');\r\n        });\r\n    }\r\n\r\n    showGameOver() {\r\n        // Check and save high score\r\n        const isNewRecord = ScoreManager.setHighScore(this.score);\r\n\r\n        this.gameOverText.setVisible(true);\r\n        this.restartText.setVisible(true);\r\n\r\n        // Show new record message if applicable\r\n        if (isNewRecord && this.score > 0) {\r\n            if (!this.newRecordText) {\r\n                this.newRecordText = this.add.text(CONFIG.GAME_WIDTH / 2, CONFIG.GAME_HEIGHT / 2 - 60, '¡NUEVO RÉCORD!', {\r\n                    fontSize: '20px',\r\n                    fontFamily: CONFIG.UI.FONT_FAMILY,\r\n                    color: '#ffff00',\r\n                    stroke: '#ff6600',\r\n                    strokeThickness: 3\r\n                });\r\n                this.newRecordText.setOrigin(0.5);\r\n                this.newRecordText.setDepth(100);\r\n            }\r\n            this.newRecordText.setVisible(true);\r\n\r\n            // Pulsing animation for new record\r\n            this.tweens.add({\r\n                targets: this.newRecordText,\r\n                scaleX: 1.2,\r\n                scaleY: 1.2,\r\n                duration: 400,\r\n                yoyo: true,\r\n                repeat: -1\r\n            });\r\n        }\r\n\r\n        // Show menu instruction\r\n        if (!this.menuText) {\r\n            this.menuText = this.add.text(CONFIG.GAME_WIDTH / 2, CONFIG.GAME_HEIGHT / 2 + CONFIG.UI.RESTART_OFFSET_Y + 30, 'PRESIONA M PARA MENÚ', {\r\n                fontSize: '14px',\r\n                fontFamily: CONFIG.UI.FONT_FAMILY,\r\n                color: '#888888'\r\n            });\r\n            this.menuText.setOrigin(0.5);\r\n            this.menuText.setDepth(100);\r\n        }\r\n        this.menuText.setVisible(true);\r\n\r\n        if (this.playerMoveTween) {\r\n            this.playerMoveTween.stop();\r\n            this.playerMoveTween = null;\r\n        }\r\n        this.moving = false;\r\n    }\r\n\r\n    resetGame(resetLevel) {\r\n        if (resetLevel) {\r\n            this.level = 1;\r\n            this.score = 0;\r\n        }\r\n        this.playerPosition = { x: 0, y: 0 };\r\n        this.generateRandomExit();\r\n        this.gameOver = false;\r\n        this.moveDirection = { dx: 0, dy: 0 };\r\n        this.desiredDirection = { dx: 0, dy: 0 };\r\n        this.canUseSave = false;\r\n\r\n        if (this.playerMoveTween) {\r\n            this.playerMoveTween.stop();\r\n            this.playerMoveTween = null;\r\n        }\r\n        this.moving = false;\r\n\r\n        this.clearSpriteCache();\r\n        this.generateMaze();\r\n        this.initialCoinCount = this.coins.length;\r\n        this.buildCollisionMap();\r\n\r\n        this.gameOverText.setVisible(false);\r\n        this.restartText.setVisible(false);\r\n        if (this.newRecordText) {\r\n            this.newRecordText.setVisible(false);\r\n        }\r\n        if (this.menuText) {\r\n            this.menuText.setVisible(false);\r\n        }\r\n\r\n        this.createGrid();\r\n\r\n        // Reset enemies\r\n        this.enemies.forEach(enemy => {\r\n            if (enemy && enemy.sprite) {\r\n                enemy.sprite.destroy();\r\n            }\r\n        });\r\n        this.enemies = [];\r\n        if (this.level >= 5) {\r\n            this.initEnemies();\r\n        }\r\n\r\n        if (this.playerDieSprite) {\r\n            this.playerDieSprite.destroy();\r\n            this.playerDieSprite = null;\r\n        }\r\n        if (this.savePulseTween) {\r\n            this.savePulseTween.stop();\r\n            this.savePulseTween = null;\r\n        }\r\n        if (this.saveSprite) {\r\n            this.saveSprite.destroy();\r\n            this.saveSprite = null;\r\n        }\r\n\r\n        this.drawGame();\r\n    }\r\n\r\n    generateSaveItem() {\r\n        const excludePositions = [\r\n            this.playerPosition,\r\n            this.exitPosition,\r\n            ...this.obstacles,\r\n            ...this.traps,\r\n            ...this.enemies.map(e => ({ x: e.x, y: e.y }))\r\n        ];\r\n\r\n        const position = generateFreePosition(excludePositions, this.boardSize);\r\n        if (position) {\r\n            if (this.saves.length === 0) {\r\n                this.saves.push(position);\r\n            }\r\n        }\r\n    }\r\n\r\n    startExitAnimation() {\r\n        if (!this.exitSprite) return;\r\n\r\n        // Stop existing tween if any\r\n        if (this.exitPulseTween) {\r\n            this.exitPulseTween.stop();\r\n        }\r\n\r\n        const baseScale = calculateSpriteScale('exit', this.cellSize, this);\r\n\r\n        // Smooth pulsing animation with scale, alpha and subtle glow\r\n        this.exitPulseTween = this.tweens.add({\r\n            targets: this.exitSprite,\r\n            scaleX: { from: baseScale * 0.95, to: baseScale * 1.1 },\r\n            scaleY: { from: baseScale * 0.95, to: baseScale * 1.1 },\r\n            alpha: { from: 0.7, to: 1.0 },\r\n            duration: 800,\r\n            ease: 'Sine.InOut',\r\n            yoyo: true,\r\n            repeat: -1\r\n        });\r\n    }\r\n\r\n    initEnemies() {\r\n        this.enemies = [];\r\n        let enemyCount = this.level >= CONFIG.ENEMIES.MIN_LEVEL_FOR_TWO ? CONFIG.ENEMIES.DOUBLE_COUNT : CONFIG.ENEMIES.SINGLE_COUNT;\r\n\r\n        for (let i = 0; i < enemyCount; i++) {\r\n            const excludePositions = [\r\n                this.playerPosition,\r\n                this.exitPosition,\r\n                ...this.obstacles,\r\n                ...this.traps,\r\n                ...this.enemies\r\n            ];\r\n\r\n            const position = generateFreePosition(excludePositions, this.boardSize);\r\n            if (!position) continue;\r\n\r\n            const enemyPosition = {\r\n                x: position.x,\r\n                y: position.y,\r\n                direction: this.getRandomDirection(),\r\n                moving: false,\r\n                sprite: null\r\n            };\r\n\r\n            enemyPosition.sprite = this.add.sprite(\r\n                enemyPosition.x * this.cellSize + this.cellSize / 2,\r\n                enemyPosition.y * this.cellSize + this.cellSize / 2,\r\n                'enemy'\r\n            );\r\n            const enemyScale = calculateSpriteScale('enemy', this.cellSize, this);\r\n            enemyPosition.sprite.setScale(enemyScale);\r\n            enemyPosition.sprite.setFlipX(enemyPosition.direction.dx === -1);\r\n\r\n            this.enemies.push(enemyPosition);\r\n        }\r\n    }\r\n\r\n    getRandomDirection() {\r\n        const directions = [\r\n            { dx: 0, dy: -1 }, { dx: 1, dy: 0 }, { dx: 0, dy: 1 }, { dx: -1, dy: 0 }\r\n        ];\r\n        return directions[Phaser.Math.Between(0, directions.length - 1)];\r\n    }\r\n\r\n    updateEnemies() {\r\n        this.enemies.forEach(enemy => {\r\n            if (!enemy || !enemy.sprite) return;\r\n\r\n            if (!enemy.moving) {\r\n                enemy.moving = true;\r\n                let nextX = enemy.x + enemy.direction.dx;\r\n                let nextY = enemy.y + enemy.direction.dy;\r\n\r\n                if (this.isCollisionOptimized(nextX, nextY)) {\r\n                    enemy.direction = this.getRandomDirection();\r\n                    enemy.moving = false;\r\n                    enemy.sprite.setFlipX(enemy.direction.dx === -1);\r\n                } else {\r\n                    this.tweens.add({\r\n                        targets: enemy.sprite,\r\n                        x: nextX * this.cellSize + this.cellSize / 2,\r\n                        y: nextY * this.cellSize + this.cellSize / 2,\r\n                        duration: CONFIG.ENEMIES.MOVE_TWEEN_DURATION_MS,\r\n                        onComplete: () => {\r\n                            enemy.x = nextX;\r\n                            enemy.y = nextY;\r\n                            enemy.moving = false;\r\n\r\n                            if (enemy.x === this.playerPosition.x && enemy.y === this.playerPosition.y) {\r\n                                this.handleDeath();\r\n                            }\r\n                        },\r\n                        callbackScope: this\r\n                    });\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    updateScoreAndLevelTexts() {\r\n        const safeScore = (typeof this.score === 'number' && !isNaN(this.score)) ? this.score : 0;\r\n        const safeLevel = (typeof this.level === 'number' && !isNaN(this.level)) ? this.level : 1;\r\n\r\n        const scoreElement = document.getElementById('score');\r\n        const levelElement = document.getElementById('level');\r\n\r\n        if (scoreElement) scoreElement.textContent = 'Puntos: ' + safeScore;\r\n        if (levelElement) levelElement.textContent = 'Nivel: ' + safeLevel;\r\n    }\r\n\r\n    shuffleMusicPlaylist() {\r\n        if (this.availableMusicKeys.length === 0) {\r\n            this.musicPlaylistOrder = [];\r\n            this.currentPlaylistIndex = 0;\r\n            return;\r\n        }\r\n        this.musicPlaylistOrder = this.availableMusicKeys.map((_, i) => this.availableMusicKeys[i]);\r\n        for (let i = this.musicPlaylistOrder.length - 1; i > 0; i--) {\r\n            const j = Math.floor(Math.random() * (i + 1));\r\n            [this.musicPlaylistOrder[i], this.musicPlaylistOrder[j]] = [this.musicPlaylistOrder[j], this.musicPlaylistOrder[i]];\r\n        }\r\n        this.currentPlaylistIndex = 0;\r\n    }\r\n\r\n    playRandomMusic() {\r\n        if (this.availableMusicKeys.length === 0) return;\r\n\r\n        if (this.backgroundMusic) {\r\n            this.backgroundMusic.stop();\r\n            this.backgroundMusic.destroy();\r\n            this.backgroundMusic = null;\r\n        }\r\n\r\n        if (this.currentPlaylistIndex >= this.musicPlaylistOrder.length) {\r\n            this.shuffleMusicPlaylist();\r\n        }\r\n\r\n        // musicPlaylistOrder now contains the actual music keys (strings), not indices\r\n        const musicKey = this.musicPlaylistOrder[this.currentPlaylistIndex];\r\n        this.currentPlaylistIndex++;\r\n\r\n        this.playSpecificMusic(musicKey);\r\n    }\r\n\r\n    playSpecificMusic(musicKey) {\r\n        try {\r\n            if (!this.cache.audio.exists(musicKey)) return;\r\n\r\n            this.backgroundMusic = this.sound.add(musicKey, {\r\n                loop: false,\r\n                volume: CONFIG.AUDIO.DEFAULT_VOLUME\r\n            });\r\n\r\n            this.backgroundMusic.play();\r\n            this.backgroundMusic.once('complete', () => {\r\n                this.playRandomMusic();\r\n            });\r\n\r\n            // Update UI\r\n            const toggleMusicButton = document.getElementById('toggle-music');\r\n            if (toggleMusicButton) toggleMusicButton.textContent = 'Música Off';\r\n\r\n        } catch (error) {\r\n            console.error('Error in playSpecificMusic:', error);\r\n        }\r\n    }\r\n\r\n    setupTouchControls() {\r\n        let swipeStartX = 0;\r\n        let swipeStartY = 0;\r\n        const minSwipeDistance = 30; // Minimum px to trigger swipe\r\n\r\n        this.input.on('pointerdown', (pointer) => {\r\n            swipeStartX = pointer.x;\r\n            swipeStartY = pointer.y;\r\n        });\r\n\r\n        this.input.on('pointerup', (pointer) => {\r\n            if (this.gameOver) return;\r\n\r\n            const dx = pointer.x - swipeStartX;\r\n            const dy = pointer.y - swipeStartY;\r\n            const absDx = Math.abs(dx);\r\n            const absDy = Math.abs(dy);\r\n\r\n            // Check if swipe is long enough\r\n            if (Math.max(absDx, absDy) < minSwipeDistance) return;\r\n\r\n            // Determine dominant direction\r\n            if (absDx > absDy) {\r\n                // Horizontal swipe\r\n                this.desiredDirection = { dx: dx > 0 ? 1 : -1, dy: 0 };\r\n            } else {\r\n                // Vertical swipe\r\n                this.desiredDirection = { dx: 0, dy: dy > 0 ? 1 : -1 };\r\n            }\r\n\r\n            // Trigger movement\r\n            if (!this.moving && !this.gameOver) {\r\n                this.movePlayer(this.desiredDirection.dx, this.desiredDirection.dy);\r\n                this.requireFreshPressAfterReset = false;\r\n            }\r\n        });\r\n    }\r\n\r\n    setupUIEventListeners() {\r\n        const toggleMusicButton = document.getElementById('toggle-music');\r\n        const volumeSlider = document.getElementById('volume-slider');\r\n        const nextButton = document.getElementById('next-music');\r\n        const prevButton = document.getElementById('prev-music');\r\n        const restartButton = document.getElementById('restart-button');\r\n\r\n        // Cleanup old listeners if any (though we are in a new class instance usually)\r\n        this.eventListenerCleanup.forEach(({ element, event, handler }) => {\r\n            if (element) element.removeEventListener(event, handler);\r\n        });\r\n        this.eventListenerCleanup = [];\r\n\r\n        const addListener = (element, event, handler) => {\r\n            if (element) {\r\n                element.addEventListener(event, handler);\r\n                this.eventListenerCleanup.push({ element, event, handler });\r\n            }\r\n        };\r\n\r\n        addListener(toggleMusicButton, 'click', () => {\r\n            const soundManager = this.sound as Phaser.Sound.WebAudioSoundManager;\r\n            if (soundManager && soundManager.context && soundManager.context.state === 'suspended') {\r\n                soundManager.context.resume().catch(() => { });\r\n            }\r\n            if (this.backgroundMusic && this.backgroundMusic.isPlaying) {\r\n                this.backgroundMusic.pause();\r\n                if (toggleMusicButton) toggleMusicButton.textContent = 'Música On';\r\n            } else if (this.backgroundMusic) {\r\n                this.backgroundMusic.resume();\r\n                if (toggleMusicButton) toggleMusicButton.textContent = 'Música Off';\r\n            } else {\r\n                this.playRandomMusic();\r\n                if (toggleMusicButton) toggleMusicButton.textContent = 'Música Off';\r\n            }\r\n        });\r\n\r\n        addListener(volumeSlider, 'input', (e) => {\r\n            if (this.backgroundMusic) {\r\n                if (this.backgroundMusic && 'setVolume' in this.backgroundMusic) {\r\n                    (this.backgroundMusic as any).setVolume(parseFloat(e.target.value));\r\n                }\r\n            }\r\n        });\r\n\r\n        addListener(nextButton, 'click', () => {\r\n            if (this.availableMusicKeys.length > 0) {\r\n                if (this.currentPlaylistIndex >= this.musicPlaylistOrder.length) {\r\n                    this.shuffleMusicPlaylist();\r\n                }\r\n                this.playRandomMusic();\r\n            }\r\n        });\r\n\r\n        addListener(prevButton, 'click', () => {\r\n            if (this.availableMusicKeys.length > 0) {\r\n                this.currentPlaylistIndex = Math.max(0, this.currentPlaylistIndex - 2);\r\n                this.playRandomMusic();\r\n            }\r\n        });\r\n\r\n        addListener(restartButton, 'click', () => {\r\n            if (this.canUseSave) {\r\n                this.resetGame(false);\r\n            } else {\r\n                this.score = 0;\r\n                this.level = 1;\r\n                this.updateScoreAndLevelTexts();\r\n                this.resetGame(true);\r\n            }\r\n        });\r\n    }\r\n}\r\n","import Phaser from 'phaser';\r\nimport { CONFIG } from './Config';\r\nimport { MenuScene } from './scenes/MenuScene';\r\nimport { GameScene } from './scenes/GameScene';\r\n\r\nconst config: Phaser.Types.Core.GameConfig = {\r\n    type: Phaser.AUTO,\r\n    width: CONFIG.GAME_WIDTH,\r\n    height: CONFIG.GAME_HEIGHT,\r\n    backgroundColor: CONFIG.UI.MAIN_BACKGROUND_COLOR,\r\n    parent: 'game-container',\r\n    pixelArt: true,\r\n    scale: {\r\n        mode: Phaser.Scale.FIT,\r\n        autoCenter: Phaser.Scale.CENTER_BOTH\r\n    },\r\n    scene: [MenuScene, GameScene]\r\n};\r\n\r\nnew Phaser.Game(config);\r\n"],"names":["CONFIG","HIGH_SCORE_KEY","ScoreManager","stored","score","current","MenuScene","Phaser","centerX","centerY","playerLogo","playButton","highScore","pointer","calculateSpriteScale","textureKey","targetSize","scene","sourceImage","originalWidth","originalHeight","error","generateFreePosition","excludePositions","boardSize","maxAttempts","attempts","position","pos","GameScene","file","keyIndex","key","maxTracks","i","filename","tryStartMusic","event","time","delta","neonColor","graphics","y","x","dot","obstacleTypes","randomType","queue","visited","directions","dir","nx","ny","obstacle","trap","freeSpaces","obs","exitScale","coin","index","coinSprite","coinScale","obstacleSprite","obstacleScale","trapSprite","trapScale","staggerDelay","tween","save","saveScale","enemy","dx","dy","moveResult","baseStepDuration","finalDestination","startX","startY","checkX","checkY","e","lastStepProcessed","result","progress","currentStep","stepStart","step","newLogicalX","newLogicalY","turnNextX","turnNextY","sprite","usedSprites","cacheKey","cache","playerScale","currentX","currentY","distance","nextX","nextY","j","playerX","playerY","distX","distY","treeSprite","swayDirection","playerDieScale","isNewRecord","resetLevel","baseScale","enemyCount","enemyPosition","enemyScale","safeScore","safeLevel","scoreElement","levelElement","_","musicKey","toggleMusicButton","swipeStartX","swipeStartY","minSwipeDistance","absDx","absDy","volumeSlider","nextButton","prevButton","restartButton","element","handler","addListener","soundManager","config"],"mappings":"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"}